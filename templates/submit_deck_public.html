{% extends "base.html" %}

{% block title %}{% if is_editing %}Edit Your Decklist{% else %}Submit Your Decklist{% endif %}{% endblock %}

{% block content %}
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
  .submit-deck-page {
    max-width: 900px;
    margin: 2rem auto;
    padding: 0 1rem;
  }
  
  .page-header {
    text-align: center;
    margin-bottom: 2rem;
    padding: 2rem;
    background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
    border-radius: 12px;
    color: white;
    box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
  }
  
  html.dark-mode .page-header {
    background: linear-gradient(135deg, #6d28d9 0%, #7c3aed 100%);
  }
  
  .page-header h1 {
    font-size: 2rem;
    margin: 0 0 0.5rem 0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }
  
  .page-header .material-icons {
    font-size: 2.5rem;
  }
  
  .page-header p {
    opacity: 0.95;
    font-size: 1.1rem;
    margin: 0;
  }
  
  .content-card {
    background: white;
    border-radius: 8px;
    padding: 2rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }
  
  html.dark-mode .content-card {
    background: #1e1e1e;
  }
  
  .info-box {
    background: #e3f2fd;
    border-left: 4px solid #2196F3;
    padding: 1rem;
    margin-bottom: 2rem;
    border-radius: 4px;
  }
  
  html.dark-mode .info-box {
    background: #1a2332;
    border-color: #42a5f5;
  }
  
  .info-box p {
    margin: 0;
    color: #0d47a1;
  }
  
  html.dark-mode .info-box p {
    color: #90caf9;
  }
  
  .info-box.warning {
    background: #fff3cd;
    border-left-color: #ffc107;
  }
  
  html.dark-mode .info-box.warning {
    background: #3a2f1a;
    border-color: #ffca28;
  }
  
  .info-box.warning p {
    color: #856404;
  }
  
  html.dark-mode .info-box.warning p {
    color: #ffd54f;
  }
  
  .form-group {
    margin-bottom: 1.5rem;
  }
  
  .form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #333;
    display: flex;
    align-items: center;
    gap: 0.3rem;
  }
  
  html.dark-mode .form-group label {
    color: #e0e0e0;
  }
  
  .form-group label .material-icons {
    font-size: 20px;
  }
  
  .deck-name-wrapper {
    position: relative;
    width: 100%;
  }
  
  .form-group input[type="text"] {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #dee2e6;
    border-radius: 4px;
    font-size: 1rem;
    transition: border-color 0.2s;
    background: white;
    color: #333;
  }
  
  html.dark-mode .form-group input[type="text"] {
    background: #2a2a2a;
    border-color: #444;
    color: #e0e0e0;
  }
  
  .form-group input[type="text"]:focus {
    outline: none;
    border-color: #7c3aed;
  }
  
  html.dark-mode .form-group input[type="text"]:focus {
    border-color: #9d5cff;
  }
  
  .help-text {
    font-size: 0.85rem;
    color: #666;
    margin-top: 0.5rem;
  }
  
  html.dark-mode .help-text {
    color: #aaa;
  }
  
  .deck-editor-wrap {
    position: relative;
    border: 2px solid #dee2e6;
    border-radius: 4px;
    background: white;
    overflow: hidden;
  }
  
  html.dark-mode .deck-editor-wrap {
    background: #2a2a2a;
    border-color: #444;
  }
  
  .deck-editor {
    min-height: 300px;
    max-height: 500px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
    font-size: 14px;
    line-height: 1.5;
    padding: 1rem;
    white-space: pre-wrap;
    word-wrap: break-word;
    overflow-y: auto;
    outline: none;
    color: #333;
  }
  
  .deck-editor::selection {
    background: #7c3aed;
    color: white;
    -webkit-text-fill-color: white;
  }
  
  .deck-editor ::-moz-selection {
    background: #7c3aed;
    color: white;
  }
  
  .deck-editor {
    user-select: text;
    -webkit-user-select: text;
    -moz-user-select: text;
    -ms-user-select: text;
  }
  
  html.dark-mode .deck-editor {
    color: #e0e0e0;
  }
  
  .deck-editor-wrap:focus-within {
    border-color: #7c3aed;
  }
  
  html.dark-mode .deck-editor-wrap:focus-within {
    border-color: #9d5cff;
  }
  
  .hl-valid { color: #2e7d32; }
  html.dark-mode .hl-valid { color: #66bb6a; }
  
  .hl-invalid { background: #f8d7da; color: #c0392b; }
  html.dark-mode .hl-invalid { background: #4a1a1a; color: #ff6b6b; }
  
  .hl-not-legal { background: #fff3cd; color: #856404; }
  html.dark-mode .hl-not-legal { background: #3a2f1a; color: #ffca28; }
  
  .quantity-error { color: #c0392b; font-weight: bold; }
  html.dark-mode .quantity-error { color: #ff6b6b; }
  
  .hl-sideboard { 
    color: #333; 
    font-weight: bold; 
    display: block;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #888;
    margin-bottom: 0.5rem;
  }
  
  html.dark-mode .hl-sideboard {
    color: #e0e0e0;
    border-color: #666;
  }
  
  .deck-loading-overlay {
    display: none;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.95);
    justify-content: center;
    align-items: center;
    flex-direction: column;
    z-index: 10;
  }
  
  html.dark-mode .deck-loading-overlay {
    background: rgba(30, 30, 30, 0.95);
  }
  
  .deck-loading-overlay.active {
    display: flex;
  }
  
  .deck-spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #7c3aed;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
  }
  
  html.dark-mode .deck-spinner {
    border-color: #444;
    border-top-color: #9d5cff;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .deck-loading-text {
    margin-top: 1rem;
    color: #666;
    font-weight: 600;
  }
  
  html.dark-mode .deck-loading-text {
    color: #aaa;
  }
  
  #deckErrors {
    margin-top: 1rem;
    padding: 1rem;
    background: #fff3cd;
    border-left: 4px solid #ffc107;
    border-radius: 4px;
    display: none;
    color: #856404;
  }
  
  html.dark-mode #deckErrors {
    background: #3a2f1a;
    border-color: #ffca28;
    color: #ffd54f;
  }
  
  #deckErrors.active {
    display: block;
  }
  
  .submit-btn {
    flex: 1;
    padding: 1rem;
    background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    height: 56px;
  }
  
  .submit-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(124, 58, 237, 0.4);
  }
  
  html.dark-mode .submit-btn:hover:not(:disabled) {
    box-shadow: 0 4px 12px rgba(157, 92, 255, 0.4);
  }
  
  .submit-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  
  .submit-btn .material-icons {
    font-size: 24px;
  }
  
  .submit-button-row {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
    align-items: flex-start;
  }
  
  .claim-checkbox-group {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 0.8;
  }
  
  .submit-button-row .claim-checkbox-wrapper {
    margin: 0;
    padding: 0;
    display: flex;
    align-items: flex-start;
    cursor: pointer;
    width: 100%;
  }
  
  .submit-button-row .claim-checkbox-wrapper input[type="checkbox"] {
    display: none;
  }
  
  .submit-button-row .checkbox-control {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    height: 56px;
    cursor: pointer;
  }
  
  .submit-button-row .checkbox-box {
    width: 24px;
    height: 24px;
    border: 2px solid #cbd5e1;
    border-radius: 4px;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    flex-shrink: 0;
  }
  
  html.dark-mode .submit-button-row .checkbox-box {
    background: #2a2a2a;
    border-color: #475569;
  }
  
  .submit-button-row .claim-checkbox-wrapper input:checked ~ .checkbox-control .checkbox-box {
    background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
    border-color: #7c3aed;
  }
  
  .submit-button-row .claim-checkbox-wrapper input:checked ~ .checkbox-control .checkbox-box::after {
    content: 'âœ“';
    color: white;
    font-weight: bold;
    font-size: 16px;
    line-height: 1;
  }
  
  .submit-button-row .checkbox-label {
    font-size: 1rem;
    font-weight: 600;
    color: #1e293b;
    white-space: nowrap;
    margin: 0;
  }
  
  html.dark-mode .submit-button-row .checkbox-label {
    color: #e2e8f0;
  }
  
  .claim-profile-hint {
    font-size: 0.85rem;
    color: #6b7280;
    text-align: center;
    padding: 0;
    display: block;
    margin-top: 0.25rem;
    font-style: italic;
  }
  
  html.dark-mode .claim-profile-hint {
    color: #9ca3af;
  }
  
  .personal-deck-selector {
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: #f0f4ff;
    border: 2px solid #7c3aed;
    border-radius: 8px;
  }
  
  html.dark-mode .personal-deck-selector {
    background: #1a1a2e;
    border-color: #9d5cff;
  }
  
  .personal-deck-selector label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #7c3aed;
  }
  
  html.dark-mode .personal-deck-selector label {
    color: #9d5cff;
  }
  
  .personal-deck-selector select {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    font-size: 1rem;
    background: white;
    cursor: pointer;
  }
  
  html.dark-mode .personal-deck-selector select {
    background: #2a2a2a;
    border-color: #444;
    color: #e0e0e0;
  }
  
  .personal-deck-selector .help-text {
    margin-top: 0.5rem;
    margin-bottom: 0;
    font-size: 0.9rem;
    color: #6b7280;
  }
  
  html.dark-mode .personal-deck-selector .help-text {
    color: #9ca3af;
  }
  
  .claim-profile-box {
    margin-bottom: 1.5rem;
    padding: 1.5rem;
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border: 2px solid #3b82f6;
    border-radius: 12px;
    text-align: center;
  }
  
  html.dark-mode .claim-profile-box {
    background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 100%);
    border-color: #60a5fa;
  }
  
  .claim-profile-notice {
    display: none;
  }
  
  .claim-profile-box h3 {
    margin: 0 0 1rem 0;
    color: #1e40af;
    font-size: 1.3rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }
  
  html.dark-mode .claim-profile-box h3 {
    color: #93c5fd;
  }
  
  .claim-profile-box p {
    margin: 0 0 1.5rem 0;
    color: #475569;
    font-size: 1rem;
  }
  
  html.dark-mode .claim-profile-box p {
    color: #cbd5e1;
  }
  
  .claim-checkbox-wrapper {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    cursor: pointer;
    padding: 1rem;
    background: white;
    border-radius: 8px;
    transition: all 0.3s;
  }
  
  html.dark-mode .claim-checkbox-wrapper {
    background: #0f172a;
  }
  
  .claim-checkbox-wrapper:hover {
    background: #eff6ff;
    transform: scale(1.02);
  }
  
  html.dark-mode .claim-checkbox-wrapper:hover {
    background: #1e293b;
  }
  
  .claim-checkbox-wrapper input[type="checkbox"] {
    display: none;
  }
  
  .claim-checkbox-icon {
    width: 48px;
    height: 48px;
    border: 3px solid #cbd5e1;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    background: white;
  }
  
  html.dark-mode .claim-checkbox-icon {
    background: #1e293b;
    border-color: #475569;
  }
  
  .claim-checkbox-wrapper input:checked + .claim-checkbox-icon {
    background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
    border-color: #7c3aed;
  }
  
  .claim-checkbox-icon .material-icons {
    font-size: 32px;
    color: transparent;
    transition: color 0.3s;
  }
  
  .claim-checkbox-wrapper input:checked + .claim-checkbox-icon .material-icons {
    color: white;
  }
  
  .claim-checkbox-label {
    font-size: 1.1rem;
    font-weight: 600;
    color: #1e293b;
  }
  
  html.dark-mode .claim-checkbox-label {
    color: #e2e8f0;
  }
  
  .success-container {
    text-align: center;
    padding: 3rem 2rem;
  }
  
  .success-icon {
    font-size: 5rem !important;
    color: #10b981;
    margin-bottom: 1rem;
  }
  
  .success-container h2 {
    color: #155724;
    margin-bottom: 1rem;
  }
  
  html.dark-mode .success-container h2 {
    color: #66bb6a;
  }
  
  .success-container p {
    color: #666;
    font-size: 1.1rem;
  }
  
  html.dark-mode .success-container p {
    color: #aaa;
  }
  
  .success-container a {
    color: #7c3aed;
    text-decoration: none;
    font-weight: 600;
  }
  
  html.dark-mode .success-container a {
    color: #9d5cff;
  }
  
  .success-container a:hover {
    text-decoration: underline;
  }
  
  .deck-link-section {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 2px solid #e0e0e0;
  }
  
  html.dark-mode .deck-link-section {
    border-top-color: #444;
  }
  
  .deck-link-section h3 {
    color: #1e293b;
    font-size: 1.2rem;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }
  
  html.dark-mode .deck-link-section h3 {
    color: #e2e8f0;
  }
  
  .deck-link-section .material-icons {
    font-size: 1.5rem;
  }
  
  .deck-link-copy-wrapper {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
  }
  
  .deck-link-input {
    flex: 1;
    padding: 0.75rem;
    border: 2px solid #7c3aed;
    border-radius: 4px;
    font-size: 0.95rem;
    background: white;
    color: #333;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
    word-break: break-all;
  }
  
  html.dark-mode .deck-link-input {
    background: #2a2a2a;
    border-color: #9d5cff;
    color: #e0e0e0;
  }
  
  .deck-link-input:focus {
    outline: none;
  }
  
  .deck-link-copy-btn {
    padding: 0.75rem 1.5rem;
    background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
    color: white;
    border: none;
    border-radius: 4px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    white-space: nowrap;
  }
  
  .deck-link-copy-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(124, 58, 237, 0.4);
  }
  
  html.dark-mode .deck-link-copy-btn:hover {
    box-shadow: 0 4px 12px rgba(157, 92, 255, 0.4);
  }
  
  .deck-link-copy-btn.copied {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  }
  
  .deck-link-copy-btn .material-icons {
    font-size: 20px;
  }
  
  .deck-link-info {
    font-size: 0.9rem;
    color: #666;
    margin-top: 1rem;
  }
  
  html.dark-mode .deck-link-info {
    color: #aaa;
  }
</style>

<div class="submit-deck-page">
  <div class="page-header">
    <h1>
      <span class="material-icons">style</span>
      {% if is_editing %}Edit Your Decklist{% else %}Submit Your Decklist{% endif %}
    </h1>
    <p>{{ tournament.name }} - {{ tournament.date.strftime('%B %d, %Y') }}</p>
  </div>
  
  <div class="content-card">
    {% if submitted %}
      <div class="success-container">
        <span class="material-icons success-icon">check_circle</span>
        <h2>{% if existing_deck %}Deck Updated!{% else %}Deck Submitted!{% endif %}</h2>
        <p>Thank you, <strong>{% if is_admin_or_scorekeeper and current_user_name %}{{ current_user_name }}{% else %}{{ player_name }}{% endif %}</strong>! {% if is_admin_or_scorekeeper and current_user_name %}The decklist for <strong>{{ player_name }}</strong> has been {% if existing_deck %}updated{% else %}received{% endif %}.{% else %}Your decklist has been {% if existing_deck %}updated{% else %}received{% endif %}.{% endif %}</p>
        {% if can_edit and submission_token %}
          <p style="margin-top: 1.5rem;">
            <a href="{{ url_for('submit_deck_public', token=submission_token) }}">
              Click here to edit your deck again
            </a>
          </p>
        {% endif %}
        
        {% if existing_deck and existing_deck.share_token %}
        <div class="deck-link-section" style="background: linear-gradient(135deg, #f0f9ff 0%, #eff6ff 100%); border: 2px solid #7c3aed; padding: 2rem; border-radius: 12px; margin-top: 2rem;">
          <h3 style="margin-top: 0; color: #1e40af; display: flex; align-items: center; gap: 0.5rem;">
            <span class="material-icons">share</span>
            ðŸŽ‰ Share Your Deck
          </h3>
          <p style="color: #1e40af; margin-bottom: 1.5rem; font-size: 1.05rem;">
            Copy this link to share your deck with others:
          </p>
          <div class="deck-link-copy-wrapper">
            <input type="text" class="deck-link-input" id="deckLinkInput" 
                   value="{{ request.url_root }}deck/share/{{ existing_deck.share_token }}" readonly
                   style="border: 2px solid #7c3aed; padding: 1rem; font-size: 1rem; flex: 1;">
            <button type="button" class="deck-link-copy-btn" id="copyDeckLinkBtn"
                   style="padding: 1rem 2rem; font-size: 1.1rem; font-weight: 700; height: auto; min-width: 140px;">
              <span class="material-icons" style="vertical-align: middle; margin-right: 0.5rem;">content_copy</span>
              Copy Link
            </button>
          </div>
          <p class="deck-link-info" style="color: #475569; margin-top: 1rem; font-style: italic;">
            ðŸ“‹ Anyone with this link can view your complete deck
          </p>
        </div>
        {% endif %}
      </div>
    {% else %}
      {% if is_editing %}
        <div class="info-box warning">
          <p>You are editing your existing decklist. Make your changes and click Submit to update.</p>
        </div>
      {% else %}
        <div class="info-box">
          <p>Welcome, <strong>{% if is_admin_or_scorekeeper and current_user_name %}{{ current_user_name }}{% else %}{{ player_name }}{% endif %}</strong>! {% if is_admin_or_scorekeeper and current_user_name %}You are submitting a decklist for <strong>{{ player_name }}</strong>.{% else %}Please submit your decklist for this tournament.{% endif %}</p>
        </div>
      {% endif %}
      
      <form method="POST">
        {% if can_claim_profile %}
        <div class="claim-profile-notice">
          <h3>
            <span class="material-icons">person_add</span>
            Claim This Profile
          </h3>
          <p>This profile hasn't been claimed yet. Claim it to manage your decks and track your tournament history!</p>
        </div>
        {% endif %}
        
        {% if personal_decks %}
        <div class="personal-deck-selector">
          <label for="personalDeckSelector">
            <span class="material-icons">collections_bookmark</span>
            Load from Your Personal Collection
          </label>
          <select id="personalDeckSelector">
            <option value="">-- Select a deck to load --</option>
            {% for deck in personal_decks %}
            <option value="{{ deck.id }}" data-name="{{ deck.name }}" data-archetype="{{ deck.archetype }}">
              {{ deck.name }} ({{ deck.archetype }})
            </option>
            {% endfor %}
          </select>
          <p class="help-text">
            ðŸ’¡ Selecting a deck will copy its contents to this form. The original deck in your collection won't be affected by changes here.
          </p>
        </div>
        {% endif %}
        
        <div class="form-group">
          <label for="deckName">
            <span class="material-icons">label</span>
            Deck Archetype
          </label>
          <div class="deck-name-wrapper">
            <input type="text" id="deckName" name="deck_name" placeholder="Enter deck name (e.g., Sligh, UW Control)..." 
                   autocomplete="off" value="{% if existing_deck %}{{ existing_deck.name }}{% endif %}" required>
          </div>
          <p class="help-text">
            ðŸ’¡ Your deck will be automatically classified based on the decklist you provide.
          </p>
        </div>
        
        <div class="form-group">
          <label for="deckEditor">
            <span class="material-icons">list_alt</span>
            Decklist
          </label>
          <div class="deck-editor-wrap">
            <div id="deckEditor" contenteditable="true" class="deck-editor" spellcheck="false" autocomplete="off" placeholder="4 Lightning Bolt
4 Counterspell
12 Island

Sideboard
3 Pyroblast"></div>
            <div id="deckLoadingOverlay" class="deck-loading-overlay">
              <div class="deck-spinner"></div>
              <div class="deck-loading-text">Validating cards...</div>
            </div>
          </div>
          <input type="hidden" id="deckList" name="deck_list">
          <div id="deckErrors"></div>
        </div>
        
        <div class="submit-button-row">
          {% if can_claim_profile %}
          <div class="claim-checkbox-group">
            <label class="claim-checkbox-wrapper" for="claimProfileCheckbox">
              <input type="checkbox" id="claimProfileCheckbox" name="claim_profile" value="true">
              <div class="checkbox-control">
                <span class="checkbox-box"></span>
                <span class="checkbox-label">Claim this profile</span>
              </div>
            </label>
            <span class="claim-profile-hint">Manage your decks & tournament history</span>
          </div>
          {% endif %}
          <button type="submit" class="submit-btn" id="saveBtn">
            <span class="material-icons">save</span>
            Submit Decklist
          </button>
        </div>
      </form>
    {% endif %}
  </div>
</div>
  
  {% if not submitted %}
  <script>
    // Wait for DOM to be ready
    document.addEventListener('DOMContentLoaded', () => {
      const deckNameInput = document.getElementById('deckName');
      const editor = document.getElementById('deckEditor');
      
      // Handle personal deck selector
      const personalDeckSelector = document.getElementById('personalDeckSelector');
      if (personalDeckSelector) {
        personalDeckSelector.addEventListener('change', async function() {
          const selectedDeckId = this.value;
          if (!selectedDeckId) return;
          
          try {
            // Fetch the deck data from API
            const response = await fetch(`/api/deck/${selectedDeckId}`);
            if (!response.ok) {
              throw new Error('Failed to load deck');
            }
            
            const deckData = await response.json();
            
            // Populate the deck name field
            if (deckNameInput) {
              deckNameInput.value = deckData.name || '';
            }
            
            // Populate the deck editor with the decklist
            if (editor && deckData.list_text) {
              editor.innerHTML = '';
              const lines = deckData.list_text.split('\n');
              lines.forEach(line => {
                const div = document.createElement('div');
                const span = document.createElement('span');
                span.textContent = line;
                div.appendChild(span);
                editor.appendChild(div);
              });
              
              // Trigger validation after populating
              setTimeout(() => {
                validateAndHighlight(true);
              }, 100);
            }
          } catch (error) {
            console.error('Error loading deck:', error);
            alert('Failed to load deck. Please try again.');
          }
        });
      }
      
      // Pre-populate deck editor if editing existing deck
      {% if existing_deck and existing_deck.list_text %}
      const existingDeckList = {{ existing_deck.list_text | tojson }};
      if (editor && existingDeckList) {
        editor.innerHTML = '';
        const lines = existingDeckList.split('\n');
        lines.forEach(line => {
          const div = document.createElement('div');
          const span = document.createElement('span');
          span.textContent = line;
          div.appendChild(span);
          editor.appendChild(div);
        });
        // Trigger validation after populating
        setTimeout(() => {
          validateAndHighlight(true);
        }, 100);
      }
      {% endif %}
    });
    
    // Deck validation logic (from new_tournament_casual.html)
    const editor = document.getElementById('deckEditor');
    const errorsDiv = document.getElementById('deckErrors');
    const loadingOverlay = document.getElementById('deckLoadingOverlay');
    const saveBtn = document.getElementById('saveBtn');
    
    const basicLands = new Set(['plains', 'island', 'swamp', 'mountain', 'forest', 'wastes']);
    
    let debounceTimer = null;
    let isValidating = false;
    
    function normalizeEditor() {
      Array.from(editor.childNodes).forEach(node => {
        if (node.nodeType === Node.TEXT_NODE) {
          const div = document.createElement('div');
          const span = document.createElement('span');
          span.textContent = node.textContent;
          div.appendChild(span);
          editor.replaceChild(div, node);
        } else if (node.nodeType === Node.ELEMENT_NODE && node.tagName !== 'DIV') {
          const div = document.createElement('div');
          const span = document.createElement('span');
          span.textContent = node.textContent;
          div.appendChild(span);
          editor.replaceChild(div, node);
        } else if (node.nodeType === Node.ELEMENT_NODE && node.tagName === 'DIV') {
          let span = node.querySelector('span');
          if (!span) {
            span = document.createElement('span');
            span.textContent = node.textContent;
            node.innerHTML = '';
            node.appendChild(span);
          }
        }
      });
      if (!editor.firstChild) {
        const div = document.createElement('div');
        const span = document.createElement('span');
        div.appendChild(span);
        editor.appendChild(div);
      }
    }
    
    function extractNamesFromLine(rawLine) {
      const trimmed = rawLine.trim();
      
      // Empty lines
      if (!trimmed) {
        return [];
      }
      
      // Sideboard marker line (exact match or standalone)
      const lowerLine = trimmed.toLowerCase();
      if (lowerLine === 'sideboard' || lowerLine === 'sb' || lowerLine === 'sideboard:') {
        return [{ name: '__SIDEBOARD__', count: 0, isSideboard: true }];
      }
      
      const tokens = trimmed.split(/\s+/);
      const cards = [];
      let currentCount = null;
      let currentName = [];

      for (let i = 0; i < tokens.length; i++) {
        const tok = tokens[i];
        const next = tokens[i + 1];

        if (/^-?\d+$/.test(tok)) {
          // count token: push any accumulated card before starting the next
          if (currentName.length > 0) {
            cards.push({ name: currentName.join(" "), count: currentCount || 1 });
            currentName = [];
          }
          currentCount = parseInt(tok);
          continue;
        } else {
          currentName.push(tok);
          // if next token is a count or end of line, finalize current card
          if (!next || /^-?\d+$/.test(next)) {
            cards.push({ name: currentName.join(" "), count: currentCount || 1 });
            currentName = [];
            currentCount = null;
          }
        }
      }
      return cards;
    }
    
    async function validateNames(names) {
      const invalid = new Set();
      const notLegal = new Set();
      const cardData = new Map();
      
      for (const name of names) {
        if (basicLands.has(name.toLowerCase())) {
          continue;
        }
        
        try {
          const url = `https://api.scryfall.com/cards/named?exact=${encodeURIComponent(name)}`;
          const response = await fetch(url);
          
          if (!response.ok) {
            invalid.add(name.toLowerCase());
          } else {
            const card = await response.json();
            cardData.set(name.toLowerCase(), card);
            if (card.legalities && card.legalities.premodern !== 'legal') {
              notLegal.add(name.toLowerCase());
            }
          }
        } catch (err) {
          invalid.add(name.toLowerCase());
        }
        
        // Add delay to avoid rate limiting
        await new Promise(resolve => setTimeout(resolve, 75));
      }
      return { invalid, notLegal, cardData };
    }
    
    async function validateAndHighlight(showLoading = false) {
      if (isValidating) return;
      isValidating = true;
      
      if (showLoading) {
        loadingOverlay.classList.add('active');
      }
      
      normalizeEditor();
      
      const lines = Array.from(editor.children).map(div => div.querySelector("span").textContent);
      const hidden = document.getElementById('deckList');
      hidden.value = lines.join("\n");
      
      // Build full list of names and count sideboards
      const names = [];
      const seen = new Set();
      let sideboardCount = 0;
      
      const perLineCards = lines.map(line => extractNamesFromLine(line));
      for (const arr of perLineCards) {
        for (const card of arr) {
          if (card.isSideboard) {
            sideboardCount++;
            continue;
          }
          const key = card.name.toLowerCase();
          if (!seen.has(key)) {
            names.push(card.name);
            seen.add(key);
          }
        }
      }
      
      const { invalid, notLegal, cardData } = await validateNames(names);
      
      // Hide loading overlay
      if (showLoading) {
        loadingOverlay.classList.remove('active');
      }
      
      // Check for quantity errors
      let hasQuantityError = false;
      const quantityErrors = [];
      
      // Check for multiple sideboards
      if (sideboardCount > 1) {
        hasQuantityError = true;
        quantityErrors.push('Multiple sideboard sections found - only one is allowed');
      }
      
      perLineCards.forEach(arr => {
        for (const card of arr) {
          if (card.isSideboard) continue;
          
          const key = card.name.toLowerCase();
          const isBasic = basicLands.has(key);
          const count = card.count;
          
          if (count <= 0 || count > (isBasic ? 999 : 4)) {
            hasQuantityError = true;
            if (count <= 0) {
              quantityErrors.push(`${card.name}: quantity must be at least 1`);
            } else {
              quantityErrors.push(`${card.name}: maximum 4 copies allowed (${count} specified)`);
            }
          }
        }
      });
      
      // Update submit button state
      const submitBtn = document.getElementById('submitBtn');
      if (submitBtn) {
        if (invalid.size > 0 || hasQuantityError) {
          submitBtn.disabled = true;
        } else {
          submitBtn.disabled = false;
        }
      }
      
      // Apply highlighting to each line
      perLineCards.forEach((arr, i) => {
        // Check if this is a sideboard line
        if (arr.length > 0 && arr[0].isSideboard) {
          const span = editor.children[i].querySelector("span");
          if (span) span.className = "hl-sideboard";
          return;
        }
        
        let isInvalid = false;
        let hasQtyError = false;
        let isNotLegal = false;
        
        for (const card of arr) {
          const key = card.name.toLowerCase();
          const count = card.count;
          const isBasic = basicLands.has(key);
          
          if (invalid.has(key)) {
            isInvalid = true;
            break;
          }
          if (count <= 0 || count > (isBasic ? 999 : 4)) {
            hasQtyError = true;
          }
          if (notLegal.has(key)) {
            isNotLegal = true;
          }
        }
        
        let cls = "hl-valid";
        if (isInvalid || hasQtyError) {
          cls = "hl-invalid";
        } else if (isNotLegal) {
          cls = "hl-not-legal";
        }
        
        const span = editor.children[i].querySelector("span");
        
        // Handle quantity errors by wrapping the number in a span
        if (hasQtyError && !isInvalid) {
          const text = span.textContent;
          const match = text.match(/^(-?\d+)\s+(.+)$/);
          if (match) {
            span.innerHTML = `<span class="quantity-error">${match[1]}</span> ${match[2]}`;
          }
        }
        
        if (span.className !== cls) span.className = cls;
      });
      
      // Display errors
      errorsDiv.innerHTML = "";
      
      // Quantity errors
      if (quantityErrors.length > 0) {
        quantityErrors.forEach(err => {
          const div = document.createElement("div");
          div.style.color = "#c0392b";
          div.textContent = err;
          errorsDiv.appendChild(div);
        });
        errorsDiv.style.display = 'block';
      }
      
      // Invalid card names
      if (invalid.size > 0) {
        const done = new Set();
        for (const nm of names) {
          const key = nm.toLowerCase();
          if (invalid.has(key) && !done.has(key)) {
            const div = document.createElement("div");
            div.textContent = `${nm} â†’ not found (exact match)`;
            errorsDiv.appendChild(div);
            done.add(key);
          }
        }
        errorsDiv.style.display = 'block';
      }
      
      // Not legal in premodern
      if (notLegal.size > 0) {
        const done = new Set();
        for (const nm of names) {
          const key = nm.toLowerCase();
          if (notLegal.has(key) && !done.has(key)) {
            const div = document.createElement("div");
            div.textContent = `${nm} â†’ not legal in Premodern`;
            errorsDiv.appendChild(div);
            done.add(key);
          }
        }
        errorsDiv.style.display = 'block';
      }
      
      if (errorsDiv.innerHTML === "") {
        errorsDiv.style.display = 'none';
      }
      
      isValidating = false;
    }
    
    editor.addEventListener('input', function() {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        validateAndHighlight(false);
      }, 300);
    });
    
    editor.addEventListener('paste', function(e) {
      e.preventDefault();
      const text = (e.clipboardData || window.clipboardData).getData('text');
      const lines = text.replace(/\r/g, '').split('\n');
      
      // Clear existing content
      editor.innerHTML = '';
      
      // Insert each line as its own div/span
      lines.forEach(line => {
        const div = document.createElement('div');
        const span = document.createElement('span');
        span.textContent = line;
        div.appendChild(span);
        editor.appendChild(div);
      });
      
      // Validate immediately with loading overlay
      setTimeout(() => {
        validateAndHighlight(true);
      }, 100);
    });
    
    // Form submission handler
    document.querySelector('form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const deckNameInput = document.getElementById('deckName');
      const deckName = deckNameInput.value.trim();
      
      if (!deckName) {
        alert('Please enter a deck name.');
        return;
      }
      
      // Extract deck lines properly (same as round.html)
      const lines = Array.from(editor.children).map(div => {
        const span = div.querySelector("span");
        return span ? span.textContent : '';
      });
      const deckText = lines.join("\n").trim();
      document.getElementById('deckList').value = deckText;
      
      if (!deckText) {
        alert('Please enter a decklist.');
        return;
      }
      
      // Submit the form (archetype will be auto-detected on server)
      this.submit();
    });
  </script>
  {% endif %}
  
  <script>
    // Handle deck link copy button on success page
    const copyBtn = document.getElementById('copyDeckLinkBtn');
    const linkInput = document.getElementById('deckLinkInput');
    
    if (copyBtn && linkInput) {
      copyBtn.addEventListener('click', function() {
        // Select the input text
        linkInput.select();
        
        // Copy to clipboard
        try {
          document.execCommand('copy');
          
          // Change button appearance
          const originalText = copyBtn.innerHTML;
          copyBtn.classList.add('copied');
          copyBtn.innerHTML = '<span class="material-icons">check</span> Copied!';
          
          // Revert after 2 seconds
          setTimeout(() => {
            copyBtn.classList.remove('copied');
            copyBtn.innerHTML = originalText;
          }, 2000);
        } catch (err) {
          alert('Failed to copy link. Please try again.');
        }
      });
    }
  </script>
{% endblock %}