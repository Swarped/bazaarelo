
  {% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/6.6.6/css/flag-icons.min.css">


  <meta charset="utf-8">
  <title>{{ player.name }} Info</title>
  <style>
    .playerinfo-page { font-family: Arial, sans-serif; max-width: 1100px; margin: 2rem auto; }
    .container { display: flex; gap: 2rem; }
    .profile-panel { flex: 0 0 250px; background:#f9f9f9; border:1px solid #ccc; border-radius:6px; padding:1rem; }
    .profile-panel h1 { font-size:1.5rem; margin-top:0; }
    .elo { font-size: 2.5rem; font-weight: bold; color: #4CAF50; margin:1rem 0; }
    .stat { margin:.5rem 0; font-size:1rem; }
    .history { flex:1; }
    
    /* Toggle Container */
    .toggle-container {
      position: relative;
      display: flex;
      width: 100%;
      height: 60px;
      background-color: #f2f2f2;
      border-radius: 8px 8px 0 0;
      border: 1px solid #ddd;
      border-bottom: none;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      margin-bottom: 0;
    }
    
    html.dark-mode .toggle-container {
      background-color: #2a2a2a;
      border-color: #444;
    }
    
    .toggle-container input {
      display: none;
    }
    
    .toggle-container label {
      flex: 1;
      text-align: center;
      line-height: 60px;
      cursor: pointer;
      z-index: 2;
      color: #666;
      font-weight: 600;
      font-size: 1.1rem;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    
    html.dark-mode .toggle-container label {
      color: #ccc;
    }
    
    .toggle-container .toggle-slider {
      position: absolute;
      top: 0;
      left: 0;
      width: 50%;
      height: 100%;
      background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
      border-radius: 8px 0 0 0;
      transition: transform 0.3s ease;
      z-index: 1;
      box-shadow: 0 2px 8px rgba(0,123,255,0.3);
    }
    
    .toggle-container input#decks:checked ~ .toggle-slider {
      transform: translateX(100%);
      border-radius: 0 8px 0 0;
    }
    
    .toggle-container input#tournaments:checked ~ .toggle-slider {
      border-radius: 8px 0 0 0;
    }
    
    .toggle-container input#tournaments:checked + label,
    .toggle-container input#decks:checked + label {
      color: white;
    }
    
    /* Panels Wrapper */
    .panels-wrapper {
      position: relative;
      overflow: hidden;
      background-color: #fff;
    }
    
    html.dark-mode .panels-wrapper {
      background-color: #1e1e1e;
    }
    
    .table-panel {
      position: absolute;
      top: 0;
      width: 100%;
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: none;
      min-height: 100%;
    }
    
    .table-panel.active {
      transform: translateX(0);
      pointer-events: auto;
      position: relative;
    }
    
    #tournaments-table {
      left: 0;
      transform: translateX(0);
    }
    
    #tournaments-table:not(.active) {
      transform: translateX(-100%);
    }
    
    #decks-table {
      left: 0;
      transform: translateX(100%);
    }
    
    #decks-table.active {
      transform: translateX(0);
    }
    
    .table-panel h2 {
      display: none;
    }
    
    table { width: 100%; border-collapse: collapse; }
    .table-panel table {
      border-top-left-radius: 0;
      border-top-right-radius: 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    th, td { border: 1px solid #ccc; padding: .5rem; text-align: center; }
    th { background: #f0f0f0; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    tr.clickable-row { transition: background-color 140ms ease, color 140ms ease; }
    tr.clickable-row:hover { background-color: #007bff; color: white; cursor: pointer; }
    tr.clickable-row:hover td { background-color: #007bff !important; color: white !important; }
    html.dark-mode tr.clickable-row:hover { background-color: #007bff !important; color: white !important; }
    html.dark-mode tr.clickable-row:hover td { background-color: #007bff !important; color: white !important; }
    .casual-tag { background:#eee; color:#333; padding:.2rem .5rem; border-radius:4px; font-size:.8rem; }
    .colors-cell { text-align: right; }
    .price-cell { text-align: center; }
    .mana-icon { width:20px; height:20px; vertical-align:middle; margin:0 2px; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: #fff; margin: 5% auto; padding: 20px; border-radius: 6px; width: 900px; max-width: 95%; display: flex; gap: 2rem; }
    .modal-left, .modal-right { flex: 1; }
    .modal-left h4, .modal-right h4 { margin-top: 0; }
    ul.card-list { list-style: none; padding: 0; margin: 0; }
    ul.card-list li { padding: .3rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    ul.card-list li:hover { background-color: #e0e0e0; }
    .modal-right img { max-width: 250px; border: 1px solid #ccc; border-radius: 4px; display: none; }
    .close { float: right; font-size: 1.2rem; cursor: pointer; }
    .btn { padding:.4rem .8rem; border:none; border-radius:4px; cursor:pointer; }
    .btn-danger { background:#d9534f; color:white; }
    .btn-primary { background:#007bff; color:white; }
  </style>
<div class="playerinfo-page"></div>

<div class="container">
  <div class="profile-panel">
    <h1>{{ player.name }}</h1>
{% if current_user.is_authenticated and current_user.is_admin %}
  <!-- Admins always see Elo -->
  <div class="elo">{{ player.elo }}</div>
{% else %}
  <!-- Regular users: only show Elo if 3+ tournaments -->
  {% if stats.tournaments_played >= 3 %}
    <div class="elo">{{ player.elo }}</div>
  {% else %}
    <div class="elo" style="color:#888;">–</div>
  {% endif %}
{% endif %}



    <div class="stat"><strong>Country:</strong> {{ player_country(player.id) or '–' }}</div>
    <div class="stat"><strong>Tournaments:</strong> {{ stats.tournaments_played }}</div>
    <div class="stat"><strong>Top 1:</strong> {{ stats.top1 }}</div>
    <div class="stat"><strong>Top 4:</strong> {{ stats.top4 }}</div>
    <div class="stat"><strong>Top 8:</strong> {{ stats.top8 }}</div>

    {% if current_user.is_authenticated and current_user.is_admin %}
      <form method="POST" action="{{ url_for('delete_player', pid=player.id) }}"
            onsubmit="return confirm('Delete {{ player.name }}?');">
        <button type="submit" class="btn btn-danger">Delete Player</button>
      </form>
      <form method="POST" action="{{ url_for('merge_player') }}">
        <input type="hidden" name="source_id" value="{{ player.id }}">
        <button type="submit" class="btn btn-primary">Merge Player</button>
      </form>
    {% endif %}
  </div>

<div class="history">
  <div class="toggle-container">
    <input type="radio" id="tournaments" name="toggle" checked>
    <label for="tournaments">Past Tournaments</label>
    <input type="radio" id="decks" name="toggle">
    <label for="decks">Decks</label>
    <div class="toggle-slider"></div>
  </div>

  <div class="panels-wrapper">
    <!-- Tournaments Table -->
    <div id="tournaments-table" class="table-panel active">
      <table>
        <tr>
          <th>Store</th>
          <th>Tournament</th>
          <th>Date</th>
          <th>Competitive/Casual</th>
          <th>Deck</th>
          <th>Colors</th>
          <th>Position</th>
          <th>Country</th>
        </tr>
        {% for h in history %}
        <tr class="clickable-row tournament-row"
            data-tournament-id="{{ h.tournament.id }}"
            data-player-name='{{ player.name|tojson }}'
            data-deck-name='{{ (h.deck.name if h.deck else "")|tojson }}'
            data-deck-list='{{ (h.deck.list_text if h.deck else "")|tojson }}'>
          <td style="padding: 0.25rem; width: 60px;">
            {% if h.tournament.store and h.tournament.store.image_url %}
              <img src="{{ url_for('static', filename=h.tournament.store.image_url) }}" 
                   alt="{{ h.tournament.store.name }}" 
                   style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; display: block;">
            {% else %}
              –
            {% endif %}
          </td>
          <td>{{ h.tournament.name }}</td>
          <td>{{ h.tournament.date }}</td>
          <td>{% if h.tournament.casual %}<span class="casual-tag">Casual</span>{% else %}Competitive{% endif %}</td>
          <td class="deck-cell">{% if h.deck %}{{ h.deck.name }}{% else %}–{% endif %}</td>
          <td class="colors-cell"></td>
          <td>{% if h.rank %}{{ h.rank }}{% else %}–{% endif %}</td>
          <td>
            {% if h.tournament.country %}
              <span class="fi fi-{{ h.tournament.country|lower }}"></span>
            {% else %}
              –
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </table>
    </div>

    <!-- Decks Table -->
    <div id="decks-table" class="table-panel">
      <table>
        <tr>
          <th>Deck Name</th>
          <th>Tournament</th>
          <th>Date</th>
          <th>Rank</th>
          <th>Colors</th>
          <th>Est. Price</th>
        </tr>
        {% for h in history %}
        {% if h.deck %}
        <tr class="clickable-row deck-row"
            data-player-name='{{ player.name|tojson }}'
            data-deck-name='{{ h.deck.name|tojson }}'
            data-deck-list='{{ h.deck.list_text|tojson }}'>
          <td class="deck-cell">{{ h.deck.name }}</td>
          <td>{{ h.tournament.name }}</td>
          <td>{{ h.tournament.date }}</td>
          <td>{% if h.rank %}{{ h.rank }}{% else %}–{% endif %}</td>
          <td class="colors-cell"></td>
          <td class="price-cell">Calculating...</td>
        </tr>
        {% endif %}
        {% endfor %}
      </table>
    </div>
  </div>
</div>

{% include '_deck_view_modal.html' %}

  <script>
    // Toggle between tournaments and decks
    function swapPanels() {
      const tournamentsRadio = document.getElementById('tournaments');
      const decksRadio = document.getElementById('decks');
      const tournamentsPanel = document.getElementById('tournaments-table');
      const decksPanel = document.getElementById('decks-table');

      if (tournamentsRadio.checked) {
        tournamentsPanel.classList.add('active');
        decksPanel.classList.remove('active');
      } else {
        tournamentsPanel.classList.remove('active');
        decksPanel.classList.add('active');
        // Compute deck colors and prices when switching to decks view
        computeAllDeckInfo();
      }
    }

    document.getElementById('tournaments').addEventListener('change', swapPanels);
    document.getElementById('decks').addEventListener('change', swapPanels);

    // Click handler for tournament rows
    document.querySelectorAll('.tournament-row').forEach(row => {
      row.addEventListener('click', function(event) {
        if (event.target.closest('.deck-cell')) {
          return; // Let the deck cell handler deal with it
        }
        const tournamentId = this.getAttribute('data-tournament-id');
        window.location.href = `/tournament/${tournamentId}/standings`;
      });
    });

    // Click handler for deck cells in tournament table
    document.querySelectorAll('.tournament-row .deck-cell').forEach(cell => {
      cell.addEventListener('click', function(event) {
        event.stopPropagation();
        openDeckModal(this.closest('.clickable-row'));
      });
    });

    // Click handler for deck rows in decks table
    document.querySelectorAll('.deck-row').forEach(row => {
      row.addEventListener('click', function(event) {
        openDeckModal(this);
      });
    });

    document.querySelectorAll('tr.clickable-row').forEach(row => {
      // Click on row goes to tournament
      row.addEventListener('click', (e) => {
        const tournamentId = row.dataset.tournamentId;
        if (tournamentId) {
          window.location.href = `/tournament/${tournamentId}/standings`;
        }
      });
      
      // Click on deck cell opens modal (stop propagation to prevent tournament navigation)
      const deckCell = row.querySelector('.deck-cell');
      if (deckCell) {
        deckCell.addEventListener('click', (e) => {
          e.stopPropagation();
          openDeckModal(row);
        });
        deckCell.style.cursor = 'zoom-in';
      }
      
      row.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          const tournamentId = row.dataset.tournamentId;
          if (tournamentId) {
            window.location.href = `/tournament/${tournamentId}/standings`;
          }
        }
      });
    });

    let symbolMap = {};
    fetch("https://api.scryfall.com/symbology")
      .then(res => res.json())
      .then(data => {
        data.data.forEach(sym => {
          symbolMap[sym.symbol] = sym.svg_uri;
        });
        // Compute colors for tournament table on load
        document.querySelectorAll('.tournament-row').forEach(row => {
          const deckListRaw = row.dataset.deckList;
          if (deckListRaw) {
            const deckList = JSON.parse(deckListRaw || '""');
            computeDeckColors(deckList, row);
          }
        });
      });

    // Compute deck colors and prices for decks table (lazy load)
    let deckInfoComputed = false;
    function computeAllDeckInfo() {
      if (deckInfoComputed) return;
      deckInfoComputed = true;

      document.querySelectorAll('.deck-row').forEach(row => {
        const deckListRaw = row.dataset.deckList;
        if (deckListRaw) {
          const deckList = JSON.parse(deckListRaw || '""');
          computeDeckColors(deckList, row);
          computeDeckPrice(deckList, row);
        }
      });
    }

    function renderManaCost(manaCost) {
      if (!manaCost) return "";
      return manaCost.replace(/\{.+?\}/g, match => {
        const uri = symbolMap[match];
        if (uri) {
          return `<img src="${uri}" alt="${match}" class="mana-icon">`;
        }
        return match;
      });
    }

    function computeDeckColors(deckList, row) {
      const colors = new Set();
      const lines = deckList.split(/\r?\n/).filter(l => l.trim() !== "");
      const promises = lines.map(line => {
        if (/^sideboard/i.test(line.trim())) return Promise.resolve();
        const parts = line.trim().split(/\s+/, 2);
        const name = line.trim().substring(parts[0].length).trim();
        if (!name) return Promise.resolve();
        return fetch(`https://api.scryfall.com/cards/named?fuzzy=${encodeURIComponent(name)}`)
          .then(res => res.json())
          .then(card => {
            if (card.color_identity) {
              card.color_identity.forEach(c => colors.add(c));
            }
          });
      });

      Promise.all(promises).then(() => {
        const cell = row.querySelector(".colors-cell");
        if (cell) {
          cell.innerHTML = "";
          ["W","U","B","R","G"].forEach(c => {
            if (colors.has(c)) {
              const token = `{${c}}`;
              const uri = symbolMap[token];
              if (uri) {
                cell.innerHTML += `<img src="${uri}" alt="${token}" class="mana-icon">`;
              }
            }
          });
        }
      });
    }

    function computeDeckPrice(deckList, row) {
      const lines = deckList.split(/\r?\n/).filter(l => l.trim() !== "");
      const cardRequests = [];
      
      for (const line of lines) {
        if (/^sideboard/i.test(line.trim())) break; // Only count main deck
        const parts = line.trim().split(/\s+/, 2);
        const count = parseInt(parts[0]);
        const name = line.trim().substring(parts[0].length).trim();
        if (!name || isNaN(count)) continue;
        cardRequests.push({ name, count });
      }

      if (cardRequests.length === 0) {
        const priceCell = row.querySelector('.price-cell');
        if (priceCell) priceCell.textContent = '–';
        return;
      }

      const promises = cardRequests.slice(0, 75).map(({ name, count }) =>
        fetch(`https://api.scryfall.com/cards/named?fuzzy=${encodeURIComponent(name)}`)
          .then(res => res.ok ? res.json() : null)
          .then(card => {
            if (card && card.prices && card.prices.usd) {
              return parseFloat(card.prices.usd) * count;
            }
            return 0;
          })
          .catch(() => 0)
      );

      Promise.all(promises).then(prices => {
        const total = prices.reduce((sum, p) => sum + p, 0);
        const priceCell = row.querySelector('.price-cell');
        if (priceCell) {
          priceCell.textContent = total > 0 ? `$${total.toFixed(2)}` : '–';
        }
      }).catch(() => {
        const priceCell = row.querySelector('.price-cell');
        if (priceCell) priceCell.textContent = '–';
      });
    }
  </script>

{% endblock %}
