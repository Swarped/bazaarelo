
  {% extends "base.html" %}

{% block title %}Deck Archetypes{% endblock %}

{% block content %}

  <meta charset="utf-8">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
<style>
  .decks-page {
    font-family: Arial, sans-serif;
    max-width: 900px;
    margin: 2rem auto;
  }


.btn {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.95rem;
  text-decoration: none;
}

.btn-primary {
  background-color: #4CAF50;
  color: white;
}
.btn-primary:hover {
  background-color: #45a049;
}

.btn-danger {
  background-color: #d9534f;
  color: white;
}
.btn-danger:hover {
  background-color: #c9302c;
}


  table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed; /* ensures consistent column widths */
  }

th, td {
  border: 1px solid #ccc;
  text-align: center;
  vertical-align: middle;
  padding: 0.3rem 0.5rem; /* less vertical padding */
  font-size: 0.95rem;
}

/* Table row animation */
@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

tr.clickable-row {
  opacity: 0;
}

tr.clickable-row.animate {
  animation: slideIn 0.5s ease-out forwards;
}

tr.clickable-row.animate:nth-child(1) { animation-delay: 0.1s; }
tr.clickable-row.animate:nth-child(2) { animation-delay: 0.15s; }
tr.clickable-row.animate:nth-child(3) { animation-delay: 0.2s; }
tr.clickable-row.animate:nth-child(4) { animation-delay: 0.25s; }
tr.clickable-row.animate:nth-child(5) { animation-delay: 0.3s; }
tr.clickable-row.animate:nth-child(6) { animation-delay: 0.35s; }
tr.clickable-row.animate:nth-child(7) { animation-delay: 0.4s; }
tr.clickable-row.animate:nth-child(8) { animation-delay: 0.45s; }
tr.clickable-row.animate:nth-child(9) { animation-delay: 0.5s; }
tr.clickable-row.animate:nth-child(n+10) { animation-delay: 0.55s; }


td.archetype-cell {
  text-align: left;
  font-weight: bold;
  position: relative;
}

.archetype-cell .edit-name-icon {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 24px;
  height: 24px;
  margin-left: 8px;
  cursor: pointer;
  border-radius: 50%;
  background: rgba(0,0,0,0.05);
  vertical-align: middle;
  transition: all 0.2s;
}

.archetype-cell .edit-name-icon:hover {
  background: rgba(0,0,0,0.1);
  transform: scale(1.1);
}

.archetype-cell .edit-name-icon .material-icons {
  font-size: 16px;
  color: #666;
}

.count-cell {
  width: 60px; /* narrower deck count column */
}

.tier-cell {
  width: 120px;
}

.tier-box {
  color: white;
  padding: .3rem .5rem;
  border-radius: 4px;
  display: inline-block;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.tier-box.tier-1 {
  background: linear-gradient(135deg, #d4af37 0%, #f0d066 100%);
  color: #1a1a1a;
  box-shadow: 0 2px 8px rgba(212, 175, 55, 0.4);
}

.tier-box.tier-2 {
  background: linear-gradient(135deg, #a8a8a8 0%, #d0d0d0 100%);
  color: #1a1a1a;
  box-shadow: 0 2px 8px rgba(168, 168, 168, 0.4);
}

.tier-box.tier-3 {
  background: linear-gradient(135deg, #b87333 0%, #d4956e 100%);
  color: #1a1a1a;
  box-shadow: 0 2px 8px rgba(184, 115, 51, 0.4);
}

.tier-box input {
  border: none;
  background: transparent;
  color: inherit;
  font-weight: 900;
  text-align: center;
  width: 80px;
  text-transform: uppercase;
  text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
}

html.dark-mode .tier-box input {
  background: transparent !important;
  color: #1a1a1a !important;
}

html.dark-mode .tier-box.tier-1 {
  background: linear-gradient(135deg, #d4af37 0%, #f0d066 100%) !important;
  color: #1a1a1a !important;
}

html.dark-mode .tier-box.tier-2 {
  background: linear-gradient(135deg, #a8a8a8 0%, #d0d0d0 100%) !important;
  color: #1a1a1a !important;
}

html.dark-mode .tier-box.tier-3 {
  background: linear-gradient(135deg, #b87333 0%, #d4956e 100%) !important;
  color: #1a1a1a !important;
}


  th {
    background: #f0f0f0;
    padding: 1rem;
  }

  tr.clickable-row:hover {
    background: linear-gradient(135deg, #bfdbfe 0%, #dbeafe 100%) !important;
    color: #1f2937 !important;
    cursor: pointer;
  }
  
  tr.clickable-row:hover td {
    background: transparent !important;
    color: #1f2937 !important;
  }
  
  tr.clickable-row:hover .archetype-img {
    filter: brightness(1.2) drop-shadow(0 0 8px rgba(255, 255, 255, 0.8));
  }
  
  html.dark-mode tr.clickable-row:hover {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%) !important;
    color: white !important;
  }
  
  html.dark-mode tr.clickable-row:hover td {
    background: transparent !important;
    color: white !important;
  }
  
  html.dark-mode tr.clickable-row:hover .archetype-img {
    filter: brightness(1.2) drop-shadow(0 0 8px rgba(255, 255, 255, 0.8));
  }

/* --- Image column --- */
th:first-child, td:first-child {
  width: 160px;   /* reduced width for smaller rows */
  padding: 0;
  text-align: center;
  vertical-align: middle;
}

/* Archetype name column */
th:nth-child(2), td:nth-child(2) {
  width: 35%;
  text-align: left;
}

/* Tier column */
th:nth-child(3), td:nth-child(3) {
  width: 100px;
}

/* Count column */
th:nth-child(4), td:nth-child(4) {
  width: 80px;
}

/* Colors column */
th:nth-child(5), td:nth-child(5) {
  width: 120px;
}

/* Price column */
th:nth-child(6), td:nth-child(6) {
  width: 100px;
}

.image-wrapper {
  position: relative;
  width: 100%;
  aspect-ratio: 2 / 1;  /* 2:1 aspect ratio */
  overflow: hidden;
}

.image-wrapper img,
.image-wrapper .placeholder {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

.edit-btn {
  position: absolute;
  top: 6px;
  right: 6px;
  background: rgba(255,255,255,0.8);
  border: none;
  cursor: pointer;
  border-radius: 50%;
  padding: 4px;
}

  .archetype-img {
    width: 100%;
    height: 100%;
    object-fit: cover; /* crop/scale to fill square */
    border-radius: 0;  /* no rounded corners */
    display: block;
  }




  /* --- Other cells --- */
  td {
    padding: 1rem;
  }

  .mana-icon {
    width: 20px;
    height: 20px;
    vertical-align: middle;
    margin: 0 2px;
  }

  .colors-cell {
    text-align: center;
    width: 120px;
  }

  /* --- Modal --- */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0; top: 0;
    width: 100%; height: 100%;
    background-color: rgba(0,0,0,0.5);
  }

  .modal-content {
    background: #fff;
    margin: 10% auto;
    padding: 20px;
    border-radius: 6px;
    width: 400px;
  }

  .close {
    float: right;
    font-size: 1.2rem;
    cursor: pointer;
  }

  form { margin-top: 1rem; }
  input[type="file"] { margin-bottom: 1rem; }

  /* Image Modal Styles */
  .image-modal-content {
    width: 90%;
    max-width: 900px;
    max-height: 90vh;
    overflow-y: auto;
  }

  .modal-tabs {
    display: flex;
    border-bottom: 2px solid #ddd;
    margin-bottom: 1rem;
  }

  .modal-tab {
    flex: 1;
    padding: 0.75rem;
    background: #f0f0f0;
    border: none;
    cursor: pointer;
    font-size: 1rem;
    transition: background 0.2s;
  }

  .modal-tab.active {
    background: #4CAF50;
    color: white;
    font-weight: bold;
  }

  .modal-tab:hover:not(.active) {
    background: #e0e0e0;
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  .image-gallery {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 1rem;
    max-height: 400px;
    overflow-y: auto;
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
  }

  .gallery-item {
    position: relative;
    cursor: pointer;
    border: 3px solid transparent;
    border-radius: 4px;
    overflow: hidden;
    transition: all 0.2s;
    aspect-ratio: 2/1;
  }

  .gallery-item:hover {
    border-color: #4CAF50;
    transform: scale(1.05);
  }

  .gallery-item.selected {
    border-color: #4CAF50;
    box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
  }

  .gallery-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .cropper-container-wrapper {
    max-height: 500px;
    margin: 1rem 0;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  #imageToCrop {
    max-width: 100%;
    display: block;
  }

  .crop-controls {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    align-items: center;
  }

  .crop-btn {
    padding: 0.5rem 1rem;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
  }

  .crop-btn:hover {
    background: #0056b3;
  }

  .crop-info {
    font-size: 0.85rem;
    color: #666;
    padding: 0.5rem;
    background: #f8f9fa;
    border-radius: 4px;
  }
  button {
    padding: .5rem 1rem;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  button:hover { background: #0056b3; }
  
  .filters-container {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    align-items: center;
    flex-wrap: wrap;
    padding: 1rem;
    background: #f5f5f5;
    border-radius: 8px;
  }
  
  html.dark-mode .filters-container {
    background: #2a2a2a;
  }
  
  .filter-group {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }
  
  .filter-group label {
    font-weight: 600;
    color: #333;
    font-size: 1.1rem;
  }
  
  html.dark-mode .filter-group label {
    color: #e5e5e5;
  }
  
  .tier-filter-btn {
    padding: 0.6rem 1.2rem;
    border: 2px solid #ccc;
    background: white;
    color: #1f2937;
    cursor: pointer;
    border-radius: 4px;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.2s;
  }
  
  .tier-filter-btn.active {
    background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
    color: white;
    border-color: #7c3aed;
  }
  
  html.dark-mode .tier-filter-btn {
    background: #2a2a2a;
    border-color: #505050;
    color: #e5e5e5;
  }
  
  html.dark-mode .tier-filter-btn.active {
    background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
    color: white;
    border-color: #a855f7;
  }
  
  .name-filter-input {
    padding: 0.6rem 1rem;
    border: 2px solid #ccc;
    border-radius: 4px;
    font-size: 1rem;
    width: 300px;
  }
  
  html.dark-mode .name-filter-input {
    background: #2a2a2a;
    border-color: #505050;
    color: #e5e5e5;
  }
</style>



<div class="decks-page"></div>

<div class="filters-container">
  <div class="filter-group">
    <label>Name:</label>
    <input type="text" class="name-filter-input" placeholder="Filter by archetype name..." id="nameFilter">
  </div>
  <div class="filter-group">
    <label>Tier:</label>
    <button class="tier-filter-btn active" data-tier="all">All</button>
    <button class="tier-filter-btn" data-tier="1">TIER 1</button>
    <button class="tier-filter-btn" data-tier="2">TIER 2</button>
    <button class="tier-filter-btn" data-tier="3">TIER 3</button>
  </div>
</div>

  <table>
    <tr>
  <th> </th>
  <th>Archetype</th>
  <th>Tier</th>
  <th>Count</th>
  <th>Colors</th>
  <th>Avg. Price</th>
</tr>

    {% for name, decks in archetypes.items() %}
    {% set last_deck = decks[-1] %}
    <tr class="clickable-row"
        data-href="{{ url_for('deck_detail', deck_name=name) }}"
        data-colors='{{ last_deck.colors if last_deck.colors else "" }}'
        data-deck-lists='{{ decks[-5:]|map(attribute="list_text")|list|tojson }}'
        data-deck-list='{{ (last_deck.list_text if last_deck.list_text else "")|tojson }}'>
      <td>
<div class="image-wrapper">
  {% if last_deck.image_url %}
    <img src="{{ url_for('static', filename=last_deck.image_url) }}" alt="{{ name }} image" class="archetype-img">
  {% else %}
    <div class="placeholder">
      <span class="material-icons">image</span>
    </div>
  {% endif %}
  {% if current_user.is_authenticated and current_user.is_admin %}
    <button class="edit-btn" data-archetype="{{ name }}"><span class="material-icons">edit</span></button>
  {% endif %}
</div>
      </td>
      <td class="archetype-cell">
        {{ name }}
        {% if current_user.is_authenticated and current_user.is_admin %}
          <span class="edit-name-icon" data-archetype="{{ name }}">
            <span class="material-icons">edit</span>
          </span>
        {% endif %}
      </td>
<td class="tier-cell">
  {% set tier = archetype_tiers.get(name, 'Tier 3') %}
  {% set tier_class = 'tier-' + tier.split()[1] %}
  <div class="tier-box {{ tier_class }}">
    <input type="text" value="{{ tier }}" readonly>
  </div>
</td>
<td class="count-cell">{{ decks|length }}</td>
<td class="colors-cell"></td>
<td class="price-cell">Calculating...</td>

    </tr>
    {% endfor %}

{% if current_user.is_authenticated and current_user.is_admin %}
<div style="margin-bottom:1rem;">
  <button type="button" class="btn btn-primary" onclick="openCreateArchetypeModal()">
    <span class="material-icons" style="font-size: 16px; vertical-align: middle;">add</span>
    Create New Archetype
  </button>
</div>
{% endif %}



  </table>

  <!-- Upload Modal -->
  <div id="uploadModal" class="modal">
    <div class="modal-content image-modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h3 id="modalTitle">Select or Upload Image</h3>
      
      <div class="modal-tabs">
        <button class="modal-tab active" onclick="switchTab('upload')">Upload New</button>
        <button class="modal-tab" onclick="switchTab('select')">Select Existing</button>
      </div>

      <!-- Upload Tab -->
      <div id="uploadTab" class="tab-content active">
        <input type="file" id="imageInput" accept="image/jpeg,image/jpg,image/png" style="margin-bottom: 1rem;">
        <div class="cropper-container-wrapper" id="cropperWrapper" style="display: none;">
          <img id="imageToCrop" />
          <div class="crop-controls">
            <button type="button" class="crop-btn" onclick="cropImage('zoom', 0.1)">üîç Zoom In</button>
            <button type="button" class="crop-btn" onclick="cropImage('zoom', -0.1)">üîç Zoom Out</button>
            <button type="button" class="crop-btn" onclick="cropImage('move', -10, 0)">‚Üê Move</button>
            <button type="button" class="crop-btn" onclick="cropImage('move', 10, 0)">Move ‚Üí</button>
            <button type="button" class="crop-btn" onclick="cropImage('move', 0, -10)">‚Üë Move</button>
            <button type="button" class="crop-btn" onclick="cropImage('move', 0, 10)">Move ‚Üì</button>
            <button type="button" class="crop-btn" onclick="cropImage('reset')">‚Ü∫ Reset</button>
          </div>
          <div class="crop-info">
            Target size: 512x256px (2:1 ratio)
          </div>
        </div>
      </div>

      <!-- Select Tab -->
      <div id="selectTab" class="tab-content">
        <p style="margin-bottom: 1rem; color: #666;">Click an image to select it:</p>
        <div id="imageGallery" class="image-gallery"></div>
      </div>

      <div style="margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: flex-end;">
        <button type="button" class="btn btn-danger" onclick="closeModal()">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveSelectedImage()" id="saveImageBtn">Save Image</button>
      </div>
    </div>
  </div>

  <!-- Create Archetype Modal -->
  <div id="createArchetypeModal" class="modal">
    <div class="modal-content image-modal-content">
      <span class="close" onclick="closeCreateArchetypeModal()">&times;</span>
      <h3>Create New Archetype</h3>
      
      <div class="modal-tabs">
        <button class="modal-tab active" onclick="switchCreateTab('upload')">Upload Image</button>
        <button class="modal-tab" onclick="switchCreateTab('select')">Select Existing</button>
      </div>

      <form id="createArchetypeForm" method="POST" action="{{ url_for('decks_list') }}" enctype="multipart/form-data">
        <div style="margin-bottom: 1rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Archetype Name</label>
          <input type="text" name="deck_name" id="createArchetypeName" placeholder="e.g. Burn, UW Control" required style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
        </div>

        <!-- Upload Tab -->
        <div id="createUploadTab" class="tab-content active">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Upload Image</label>
          <input type="file" name="image" id="createImageInput" accept="image/jpeg,image/jpg,image/png" style="margin-bottom: 1rem;">
          <div class="cropper-container-wrapper" id="createCropperWrapper" style="display: none;">
            <img id="createImageToCrop" />
            <div class="crop-controls">
              <button type="button" class="crop-btn" onclick="cropCreateImage('zoom', 0.1)">üîç Zoom In</button>
              <button type="button" class="crop-btn" onclick="cropCreateImage('zoom', -0.1)">üîç Zoom Out</button>
              <button type="button" class="crop-btn" onclick="cropCreateImage('move', -10, 0)">‚Üê Move</button>
              <button type="button" class="crop-btn" onclick="cropCreateImage('move', 10, 0)">Move ‚Üí</button>
              <button type="button" class="crop-btn" onclick="cropCreateImage('move', 0, -10)">‚Üë Move</button>
              <button type="button" class="crop-btn" onclick="cropCreateImage('move', 0, 10)">Move ‚Üì</button>
              <button type="button" class="crop-btn" onclick="cropCreateImage('reset')">‚Ü∫ Reset</button>
            </div>
            <div class="crop-info">Target size: 512x256px (2:1 ratio)</div>
          </div>
        </div>

        <!-- Select Tab -->
        <div id="createSelectTab" class="tab-content">
          <p style="margin-bottom: 1rem; color: #666;">Click an image to select it:</p>
          <div id="createImageGallery" class="image-gallery"></div>
          <input type="hidden" name="existing_image" id="createExistingImage">
        </div>

        <div style="margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: flex-end;">
          <button type="button" class="btn btn-danger" onclick="closeCreateArchetypeModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Archetype</button>
        </div>
      </form>
    </div>
  </div>

    <!-- Edit Name Modal -->
  <div id="editNameModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeEditNameModal()">&times;</span>
      <h3 id="editNameTitle">Edit Archetype Name</h3>
      <form id="editNameForm" method="POST">
        <input type="text" name="new_name" id="newNameInput" required>
        <button type="submit">Save Name</button>
      </form>
    </div>
  </div>





  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
  <script>
    let cropper = null;
    let currentArchetype = null;
    let selectedExistingImage = null;
    let availableImages = [];

    // Load available images
    async function loadAvailableImages() {
      try {
        const response = await fetch("{{ url_for('get_available_images') }}");
        availableImages = await response.json();
        renderImageGallery();
      } catch (error) {
        console.error('Error loading images:', error);
        availableImages = [];
      }
    }

    // Render image gallery
    function renderImageGallery() {
      const gallery = document.getElementById('imageGallery');
      gallery.innerHTML = '';
      
      if (availableImages.length === 0) {
        gallery.innerHTML = '<p style="color: #999; text-align: center; padding: 2rem;">No images available</p>';
        return;
      }

      availableImages.forEach(imagePath => {
        const item = document.createElement('div');
        item.className = 'gallery-item';
        item.innerHTML = `<img src="/static/${imagePath}" alt="Image">`;
        item.onclick = () => selectExistingImage(imagePath, item);
        gallery.appendChild(item);
      });
    }

    // Select existing image
    function selectExistingImage(imagePath, element) {
      selectedExistingImage = imagePath;
      document.querySelectorAll('.gallery-item').forEach(item => item.classList.remove('selected'));
      element.classList.add('selected');
    }

    // Switch tabs
    function switchTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.modal-tab').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');

      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(tabName + 'Tab').classList.add('active');

      // Reset selections
      if (tabName === 'upload') {
        selectedExistingImage = null;
        document.querySelectorAll('.gallery-item').forEach(item => item.classList.remove('selected'));
      }
    }

    // Handle file input
    document.addEventListener('DOMContentLoaded', () => {
      loadAvailableImages();

      const imageInput = document.getElementById('imageInput');
      if (imageInput) {
        imageInput.addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
              const image = document.getElementById('imageToCrop');
              image.src = event.target.result;
              document.getElementById('cropperWrapper').style.display = 'block';
              
              // Destroy previous cropper if exists
              if (cropper) {
                cropper.destroy();
              }

              // Initialize cropper
              cropper = new Cropper(image, {
                aspectRatio: 2 / 1,  // 512x256 = 2:1
                viewMode: 2,
                autoCropArea: 1,
                responsive: true,
                guides: true,
                center: true,
                highlight: true,
                cropBoxResizable: true,
                cropBoxMovable: true,
                toggleDragModeOnDblclick: false,
              });
            };
            reader.readAsDataURL(file);
          }
        });
      }
    });

    // Crop controls
    function cropImage(action, ...args) {
      if (!cropper) return;
      
      switch(action) {
        case 'zoom':
          cropper.zoom(args[0]);
          break;
        case 'move':
          cropper.move(args[0], args[1]);
          break;
        case 'reset':
          cropper.reset();
          break;
      }
    }

    // Save selected/cropped image
    async function saveSelectedImage() {
      if (!currentArchetype) {
        alert('No archetype selected');
        return;
      }

      const activeTab = document.querySelector('.tab-content.active').id;
      
      if (activeTab === 'selectTab') {
        // Save existing image selection
        if (!selectedExistingImage) {
          alert('Please select an image');
          return;
        }
        
        await saveExistingImage(selectedExistingImage);
      } else {
        // Save cropped image
        if (!cropper) {
          alert('Please select an image to upload');
          return;
        }
        
        await saveCroppedImage();
      }
    }

    // Save existing image
    async function saveExistingImage(imagePath) {
      try {
        const formData = new FormData();
        formData.append('existing_image', imagePath);
        
        const response = await fetch(`/archetype/${encodeURIComponent(currentArchetype)}/edit`, {
          method: 'POST',
          body: formData
        });
        
        if (response.ok) {
          window.location.reload();
        } else {
          alert('Error saving image');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error saving image');
      }
    }

    // Save cropped image
    async function saveCroppedImage() {
      try {
        const canvas = cropper.getCroppedCanvas({
          width: 512,
          height: 256,
          imageSmoothingQuality: 'high'
        });
        
        canvas.toBlob(async (blob) => {
          const formData = new FormData();
          formData.append('image', blob, 'cropped.jpg');
          
          const response = await fetch(`/archetype/${encodeURIComponent(currentArchetype)}/edit`, {
            method: 'POST',
            body: formData
          });
          
          if (response.ok) {
            window.location.reload();
          } else {
            alert('Error saving image');
          }
        }, 'image/jpeg', 0.9);
      } catch (error) {
        console.error('Error:', error);
        alert('Error saving image');
      }
    }

    // Make rows clickable
    document.querySelectorAll('tr.clickable-row').forEach(row=>{
      row.addEventListener('click', e=>{
        // prevent row click if edit button clicked
        if(e.target.closest('.edit-btn')) return;
        const href=row.getAttribute('data-href');
        if(href) window.location.href=href;
      });
    });

    // Edit button opens modal
    document.querySelectorAll('.edit-btn').forEach(btn=>{
      btn.addEventListener('click', e=>{
        e.stopPropagation();
        const archetype = btn.getAttribute('data-archetype');
        currentArchetype = archetype;
        document.getElementById('modalTitle').textContent = "Select or Upload Image for " + archetype;
        
        // Reset modal state
        switchTab('upload');
        document.getElementById('imageInput').value = '';
        document.getElementById('cropperWrapper').style.display = 'none';
        if (cropper) {
          cropper.destroy();
          cropper = null;
        }
        selectedExistingImage = null;
        document.querySelectorAll('.gallery-item').forEach(item => item.classList.remove('selected'));
        
        // Set first tab as active
        document.querySelectorAll('.modal-tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.modal-tab')[0].classList.add('active');
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById('uploadTab').classList.add('active');
        
        document.getElementById('uploadModal').style.display = 'block';
      });
    });

    function closeModal() {
      document.getElementById('uploadModal').style.display = 'none';
      if (cropper) {
        cropper.destroy();
        cropper = null;
      }
      currentArchetype = null;
      selectedExistingImage = null;
    }

    // Edit Name button opens modal
    document.querySelectorAll('.edit-name-icon').forEach(btn=>{
      btn.addEventListener('click', e=>{
        e.stopPropagation();
        const archetype = btn.getAttribute('data-archetype');
        document.getElementById('editNameTitle').textContent = "Edit Archetype Name: " + archetype;
        const form = document.getElementById('editNameForm');
        form.action = "/archetype/" + encodeURIComponent(archetype) + "/edit_name";
        document.getElementById('editNameModal').style.display = 'block';
      });
    });
    function closeEditNameModal() {
      document.getElementById('editNameModal').style.display = 'none';
    }

    // Create archetype modal functions
    let createCropper = null;
    let createSelectedImage = null;

    function openCreateArchetypeModal() {
      document.getElementById('createArchetypeModal').style.display = 'block';
      loadCreateArchetypeImages();
    }

    function closeCreateArchetypeModal() {
      document.getElementById('createArchetypeModal').style.display = 'none';
      if (createCropper) {
        createCropper.destroy();
        createCropper = null;
      }
      document.getElementById('createArchetypeForm').reset();
      document.getElementById('createCropperWrapper').style.display = 'none';
      createSelectedImage = null;
    }

    function switchCreateTab(tab) {
      document.querySelectorAll('#createArchetypeModal .modal-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('#createArchetypeModal .tab-content').forEach(t => t.classList.remove('active'));
      
      if (tab === 'upload') {
        document.querySelector('#createArchetypeModal .modal-tab:nth-child(1)').classList.add('active');
        document.getElementById('createUploadTab').classList.add('active');
      } else {
        document.querySelector('#createArchetypeModal .modal-tab:nth-child(2)').classList.add('active');
        document.getElementById('createSelectTab').classList.add('active');
      }
    }

    async function loadCreateArchetypeImages() {
      const gallery = document.getElementById('createImageGallery');
      gallery.innerHTML = '<p>Loading images...</p>';
      
      try {
        const response = await fetch('/api/deck_images');
        const images = await response.json();
        
        if (images.length === 0) {
          gallery.innerHTML = '<p style="text-align: center; color: #999;">No images available</p>';
          return;
        }
        
        gallery.innerHTML = '';
        images.forEach(img => {
          const div = document.createElement('div');
          div.className = 'gallery-item';
          div.innerHTML = `<img src="/static/${img}" alt="Deck image">`;
          div.onclick = () => selectCreateImage(img, div);
          gallery.appendChild(div);
        });
      } catch (error) {
        gallery.innerHTML = '<p style="color: red;">Error loading images</p>';
      }
    }

    function selectCreateImage(imagePath, element) {
      document.querySelectorAll('#createImageGallery .gallery-item').forEach(item => {
        item.classList.remove('selected');
      });
      element.classList.add('selected');
      createSelectedImage = imagePath;
      document.getElementById('createExistingImage').value = imagePath;
    }

    document.getElementById('createImageInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      if (createCropper) {
        createCropper.destroy();
      }
      
      const reader = new FileReader();
      reader.onload = function(event) {
        const img = document.getElementById('createImageToCrop');
        img.src = event.target.result;
        document.getElementById('createCropperWrapper').style.display = 'flex';
        
        createCropper = new Cropper(img, {
          aspectRatio: 2 / 1,
          viewMode: 1,
          autoCropArea: 1,
          responsive: true,
          background: false
        });
      };
      reader.readAsDataURL(file);
    });

    function cropCreateImage(action, ...args) {
      if (!createCropper) return;
      
      switch(action) {
        case 'zoom':
          createCropper.zoom(args[0]);
          break;
        case 'move':
          createCropper.move(args[0], args[1]);
          break;
        case 'reset':
          createCropper.reset();
          break;
      }
    }

    // Handle form submission with cropped image
    document.getElementById('createArchetypeForm').addEventListener('submit', async function(e) {
      const activeTab = document.querySelector('#createArchetypeModal .tab-content.active').id;
      
      if (activeTab === 'createUploadTab' && createCropper) {
        e.preventDefault();
        
        const canvas = createCropper.getCroppedCanvas({
          width: 512,
          height: 256,
          imageSmoothingQuality: 'high'
        });
        
        canvas.toBlob(async (blob) => {
          const formData = new FormData();
          formData.append('deck_name', document.getElementById('createArchetypeName').value);
          formData.append('image', blob, 'archetype.jpg');
          
          const response = await fetch('{{ url_for("decks_list") }}', {
            method: 'POST',
            body: formData
          });
          
          if (response.ok) {
            window.location.reload();
          } else {
            alert('Error creating archetype');
          }
        }, 'image/jpeg', 0.9);
      }
    });


    // Render colors
    let symbolMap = {};
    let cardCache = {}; // Cache for card lookups
    
    // Compute colors from deck list
    function computeDeckColors(deckList, row) {
      const colors = new Set();
      const lines = deckList.split(/\r?\n/).filter(l => l.trim() !== "");
      const promises = lines.map(line => {
        if (/^sideboard/i.test(line.trim())) return Promise.resolve();
        const parts = line.trim().split(/\s+/, 2);
        const name = line.trim().substring(parts[0].length).trim();
        if (!name) return Promise.resolve();
        return fetch(`https://api.scryfall.com/cards/named?fuzzy=${encodeURIComponent(name)}`)
          .then(res => res.json())
          .then(card => {
            if (card.color_identity) {
              card.color_identity.forEach(c => colors.add(c));
            }
          })
          .catch(() => {});
      });

      return Promise.all(promises).then(() => {
        const cell = row.querySelector(".colors-cell");
        if (cell) {
          cell.innerHTML = "";
          ["W","U","B","R","G"].forEach(c => {
            if (colors.has(c)) {
              cell.innerHTML += `<img src="https://svgs.scryfall.io/card-symbols/${c}.svg" alt="${c}" class="mana-icon">`;
            }
          });
        }
      });
    }
    
    // Compute deck price from latest deck submission
    function computeDeckPrice(deckList, row) {
      let totalPrice = 0;
      const lines = deckList.split(/\r?\n/).filter(l => l.trim() !== "");
      const promises = lines.map(line => {
        if (/^sideboard/i.test(line.trim())) return Promise.resolve();
        const parts = line.trim().split(/\s+/, 2);
        const count = parseInt(parts[0]) || 0;
        const name = line.trim().substring(parts[0].length).trim();
        if (!name || count === 0) return Promise.resolve();
        
        return fetch(`https://api.scryfall.com/cards/search?q=!"${encodeURIComponent(name)}" -set:lea -set:leb -set:2ed -set:3ed -set:ced -set:cei -set:fbb -set:sum&unique=prints&order=released&dir=asc`)
          .then(res => res.json())
          .then(data => {
            const editions = data.data || [];
            let cheapestPrice = null;
            
            editions.forEach(edition => {
              const usd = parseFloat(edition.prices?.usd);
              const usdFoil = parseFloat(edition.prices?.usd_foil);
              
              if (!isNaN(usd) && usd > 0) {
                if (cheapestPrice === null || usd < cheapestPrice) {
                  cheapestPrice = usd;
                }
              }
              if (!isNaN(usdFoil) && usdFoil > 0) {
                if (cheapestPrice === null || usdFoil < cheapestPrice) {
                  cheapestPrice = usdFoil;
                }
              }
            });
            
            if (cheapestPrice !== null) {
              totalPrice += cheapestPrice * count;
            }
          })
          .catch(() => {});
      });

      Promise.all(promises).then(() => {
        const cell = row.querySelector(".price-cell");
        if (cell) {
          cell.textContent = totalPrice > 0 ? `$${totalPrice.toFixed(2)}` : 'N/A';
        }
      });
    }
    
    // Compute colors and prices from latest deck submission
    const rows = document.querySelectorAll('tr.clickable-row');
    const colorPromises = [];
    
    rows.forEach(row => {
      const deckListRaw = row.dataset.deckList;
      if (deckListRaw) {
        const deckList = JSON.parse(deckListRaw || '""');
        const colorPromise = computeDeckColors(deckList, row);
        colorPromises.push(colorPromise);
        computeDeckPrice(deckList, row);
      }
    });
    
    // Wait for all colors to be calculated, then show animation
    Promise.all(colorPromises).then(() => {
      rows.forEach(row => {
        row.classList.add('animate');
      });
    });
    
    // Filter functionality
    let currentTierFilter = 'all';
    let currentNameFilter = '';
    
    function applyFilters() {
      const rows = document.querySelectorAll('tr.clickable-row');
      rows.forEach(row => {
        const tierInput = row.querySelector('.tier-box input');
        const tierText = tierInput ? tierInput.value : '';
        const tierNum = tierText.split(' ')[1]; // Extract "1", "2", or "3" from "Tier 1"
        
        const archetypeName = row.querySelector('.archetype-cell').textContent.trim().toLowerCase();
        
        let showRow = true;
        
        // Tier filter
        if (currentTierFilter !== 'all' && tierNum !== currentTierFilter) {
          showRow = false;
        }
        
        // Name filter
        if (currentNameFilter && !archetypeName.includes(currentNameFilter.toLowerCase())) {
          showRow = false;
        }
        
        row.style.display = showRow ? '' : 'none';
      });
    }
    
    // Tier filter buttons
    document.querySelectorAll('.tier-filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tier-filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentTierFilter = btn.dataset.tier;
        applyFilters();
      });
    });
    
    // Name filter input
    document.getElementById('nameFilter').addEventListener('input', (e) => {
      currentNameFilter = e.target.value;
      applyFilters();
    });
  </script>

{% endblock %}