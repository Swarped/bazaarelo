{% extends "base.html" %}

{% block title %}Players{% endblock %}

{% block content %}

    <meta charset="utf-8">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/6.6.6/css/flag-icons.min.css">


    <style>

      .material-icons {
        font-size: 18px;
        vertical-align: middle;
        margin-right: 4px;
      }

.players-page {
  width: 100%;        /* respects scrollbar */
  margin: 0;
  padding: 0;    /* remove padding since container already has it */
  box-sizing: border-box;
}


  .players-page > div {
  display: flex;
  gap: 2rem;
  align-items: flex-start;
  flex-wrap: nowrap;   /* prevent aside from wrapping below */
}

.players-page header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
}

      h1 {
        margin: 0;
        font-size: 1.8rem;
        color: #2c3e50;
      }

      .btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.95rem;
        text-decoration: none;
      }

      .btn-primary {
        background-color: #4caf50;
        color: white;
      }
      .btn-primary:hover {
        background-color: #45a049;
      }

      .btn-danger {
        background-color: #d9534f;
        color: white;
      }
      .btn-danger:hover {
        background-color: #c9302c;
      }

      #searchBar {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 0.95rem;
        background-color: #fff;
        transition: all 0.3s ease;
      }

      #searchBar:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
      }

      #searchBar::placeholder {
        color: #999;
      }

      html.dark-mode #searchBar {
        background-color: #2a2a2a;
        border-color: #444;
        color: #e0e0e0;
      }

      html.dark-mode #searchBar::placeholder {
        color: #777;
      }

      /* Smooth row animations for filtering */
      #playersTable,
      #casualPlayersTable {
        table-layout: fixed;
        width: 100%;
      }

      #playersTable tr,
      #casualPlayersTable tr {
        transition: opacity 0.3s ease, transform 0.3s ease;
      }

      /* Initial page load animation */
      #playersTable tr:not(:first-child),
      #casualPlayersTable tr:not(:first-child) {
        opacity: 0;
        transform: translateY(20px);
      }

      #playersTable tr:not(:first-child).loaded,
      #casualPlayersTable tr:not(:first-child).loaded {
        opacity: 1;
        transform: translateY(0);
      }

      /* Stagger the transition delay for each row on page load */
      #playersTable tr.loaded:nth-child(2) { transition-delay: 0.05s; }
      #playersTable tr.loaded:nth-child(3) { transition-delay: 0.1s; }
      #playersTable tr.loaded:nth-child(4) { transition-delay: 0.15s; }
      #playersTable tr.loaded:nth-child(5) { transition-delay: 0.2s; }
      #playersTable tr.loaded:nth-child(6) { transition-delay: 0.25s; }
      #playersTable tr.loaded:nth-child(7) { transition-delay: 0.3s; }
      #playersTable tr.loaded:nth-child(8) { transition-delay: 0.35s; }
      #playersTable tr.loaded:nth-child(9) { transition-delay: 0.4s; }
      #playersTable tr.loaded:nth-child(10) { transition-delay: 0.45s; }
      #playersTable tr.loaded:nth-child(n+11) { transition-delay: 0.5s; }

      #casualPlayersTable tr.loaded:nth-child(2) { transition-delay: 0.05s; }
      #casualPlayersTable tr.loaded:nth-child(3) { transition-delay: 0.1s; }
      #casualPlayersTable tr.loaded:nth-child(4) { transition-delay: 0.15s; }
      #casualPlayersTable tr.loaded:nth-child(5) { transition-delay: 0.2s; }
      #casualPlayersTable tr.loaded:nth-child(6) { transition-delay: 0.25s; }
      #casualPlayersTable tr.loaded:nth-child(7) { transition-delay: 0.3s; }
      #casualPlayersTable tr.loaded:nth-child(8) { transition-delay: 0.35s; }
      #casualPlayersTable tr.loaded:nth-child(9) { transition-delay: 0.4s; }
      #casualPlayersTable tr.loaded:nth-child(10) { transition-delay: 0.45s; }
      #casualPlayersTable tr.loaded:nth-child(n+11) { transition-delay: 0.5s; }

      #playersTable tr.hidden,
      #casualPlayersTable tr.hidden {
        opacity: 0;
        transform: translateY(-5px);
        position: absolute;
        visibility: hidden;
        transition-delay: 0s !important;
      }

      /* Don't animate the header row */
      #playersTable tr:first-child,
      #casualPlayersTable tr:first-child {
        transition: none;
        position: static !important;
        visibility: visible !important;
        opacity: 1 !important;
        transform: none !important;
      }

      html.dark-mode #searchBar:focus {
        border-color: #4a9eff;
        box-shadow: 0 0 0 3px rgba(74,158,255,0.15);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      }

      th, td {
        border: 1px solid #ddd;
        padding: 0.75rem;
        text-align: left;
        vertical-align: middle;
      }

      th {
        background-color: #f2f2f2;
        color: #2c3e50;
      }

      tr:nth-child(even) {
        background-color: #f9f9f9;
      }


      .flash-error {
        background: #f8d7da;
        color: #721c24;
        padding: .5rem;
        margin-bottom: 1rem;
        border: 1px solid #f5c6cb;
      }
      .flash-success {
        background: #d4edda;
        color: #155724;
        padding: .5rem;
        margin-bottom: 1rem;
        border: 1px solid #c3e6cb;
      }

      td.actions {
        width: 180px;
      }

      .player-actions {
        display: none;
        gap: 0.5rem;
      }
      tr:hover .player-actions {
        display: inline-flex;
      }

      tr:hover {
  background-color: #007bff; /* vivid blue */
  color: #fff;               /* white text */
    cursor: pointer;           /* show pointer hand */
}
tr:hover td, tr:hover th {
  color: #fff;               /* ensure all cells switch to white */
}

.country-select {
  padding: 0.75rem 1rem;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 0.95rem;
  background-color: #fff;
  cursor: pointer;
  min-width: 180px;
  transition: all 0.3s ease;
}

.country-select:focus {
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
}

.country-select option {
  padding: 0.5rem;
}

html.dark-mode .country-select {
  background-color: #2a2a2a;
  border-color: #444;
  color: #e0e0e0;
}

html.dark-mode .country-select:focus {
  border-color: #4a9eff;
  box-shadow: 0 0 0 3px rgba(74,158,255,0.15);
}

html.dark-mode .country-select option {
  background-color: #2a2a2a;
  color: #e0e0e0;
}

.filters-toolbar {
  display: flex;
  gap: 1rem;
  padding: 1rem;
  background-color: #fff;
  border: 1px solid #ddd;
  border-top: none;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  align-items: center;
}

html.dark-mode .filters-toolbar {
  background-color: #1e1e1e;
  border-color: #444;
}

.filter-group {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.filter-group label {
  font-size: 0.9rem;
  color: #666;
  font-weight: 500;
  white-space: nowrap;
}

html.dark-mode .filter-group label {
  color: #ccc;
}

#tablesColumn {
  flex: 1;
  min-width: 0;
  position: relative;
  min-height: 400px; /* adjust to your tallest table */
}

aside {
  width: 240px;
  flex-shrink: 0;      /* keep aside fixed width */
}

html.dark-mode .store-card-info {
  background: #2a2a2a !important;
  border-top-color: #444 !important;
}

html.dark-mode .store-card-name {
  color: #e0e0e0 !important;
}

html.dark-mode .store-card-location {
  color: #ccc !important;
}

html.dark-mode .store-card-image {
  background-color: #1a1a1a !important;
}

html.dark-mode .store-card-link:hover {
  box-shadow: 0 4px 8px rgba(255,255,255,0.1) !important;
}

html.dark-mode .deck-card-link:hover {
  box-shadow: 0 4px 8px rgba(255,255,255,0.1) !important;
}

/* Blog Card Dark Mode */
html.dark-mode .blog-card-link {
  background: #2a2a2a !important;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
}

html.dark-mode .blog-card-link:hover {
  box-shadow: 0 4px 12px rgba(255,255,255,0.1) !important;
}

html.dark-mode .blog-card-title {
  color: #e0e0e0 !important;
}

html.dark-mode .blog-card-excerpt {
  color: #b0b0b0 !important;
}

html.dark-mode .blog-card-meta {
  border-top-color: #444 !important;
  color: #888 !important;
}

html.dark-mode .blog-card-content {
  background: #2a2a2a !important;
}

html.dark-mode .blog-card-image {
  background-color: #1a1a1a !important;
}

html.dark-mode .featured-posts-section h2 {
  color: #e0e0e0 !important;
}

/* Blog Card Dark Mode */
html.dark-mode .blog-card-link {
  background: #2a2a2a !important;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
}

html.dark-mode .blog-card-link:hover {
  box-shadow: 0 4px 12px rgba(255,255,255,0.1) !important;
}

html.dark-mode .blog-card-title {
  color: #e0e0e0 !important;
}

html.dark-mode .blog-card-excerpt {
  color: #b0b0b0 !important;
}

html.dark-mode .blog-card-meta {
  border-top-color: #444 !important;
  color: #888 !important;
}

html.dark-mode .blog-card-content {
  background: #2a2a2a !important;
}

html.dark-mode .blog-card-image {
  background-color: #1a1a1a !important;
}

      .action-btn {
        padding: 0.3rem 0.6rem;
        font-size: 0.85rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .btn-delete {
        background-color: #d9534f;
        color: white;
      }
      .btn-delete:hover { background-color: #c9302c; }
      .btn-merge {
        background-color: #4cae4f;
        color: white;
      }
      .btn-merge:hover { background-color: #409943; }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0; top: 0;
        width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.5);
      }
      .modal-content {
        background-color: #fff;
        margin: 10% auto;
        padding: 20px;
        border-radius: 6px;
        width: 320px;
        text-align: left;
      }
      .modal-content h3 {
        margin-top: 0;
        margin-bottom: 1rem;
      }
      .modal-content input, .modal-content select {
        width: 100%;
        padding: 0.5rem;
        margin-bottom: 1rem;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      .close {
        float: right;
        font-size: 1.2rem;
        cursor: pointer;
      }

      .toggle-container {
  position: relative;
  display: flex;
  width: 100%;
  height: 60px;
  background-color: #f2f2f2;
  border-radius: 8px 8px 0 0;
  border: 1px solid #ddd;
  border-bottom: none;
  overflow: hidden;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

html.dark-mode .toggle-container {
  background-color: #2a2a2a;
  border-color: #444;
}

.toggle-container input {
  display: none;
}

.toggle-container label {
  flex: 1;
  text-align: center;
  line-height: 60px;
  cursor: pointer;
  z-index: 2;
  color: #666;
  font-weight: 600;
  font-size: 1.1rem;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}

html.dark-mode .toggle-container label {
  color: #ccc;
}

.panels-wrapper {
  position: relative;
  overflow: hidden;
  background-color: #fff;
}

html.dark-mode .panels-wrapper {
  background-color: #1e1e1e;
}

.table-panel {
  position: absolute;
  top: 0;
  width: 100%;
  transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  pointer-events: none;
  min-height: 100%;
}

.table-panel.active {
  transform: translateX(0);
  pointer-events: auto;
  position: relative;
}

#competitive-table {
  left: 0;
  transform: translateX(0);
}

#competitive-table:not(.active) {
  transform: translateX(-100%);
}

#casual-table {
  left: 0;
  transform: translateX(100%);
}

#casual-table.active {
  transform: translateX(0);
}

/* Blog Carousel Styling */
.carousel-prev:hover, .carousel-next:hover {
  background: rgba(255,255,255,1) !important;
}

.carousel-dot.active {
  background: rgba(255,255,255,1) !important;
  transform: scale(1.3);
}

.blog-read-more:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(0,0,0,0.4) !important;
}

html.dark-mode .blog-carousel {
  box-shadow: 0 2px 8px rgba(0,0,0,0.4) !important;
}

html.dark-mode .blog-slide > div {
  background: #2a2a2a !important;
}

html.dark-mode .carousel-prev,
html.dark-mode .carousel-next {
  background: rgba(42,42,42,0.9) !important;
}

html.dark-mode .carousel-prev:hover,
html.dark-mode .carousel-next:hover {
  background: rgba(42,42,42,1) !important;
}

html.dark-mode .carousel-prev i,
html.dark-mode .carousel-next i {
  color: #e0e0e0 !important;
}

html.dark-mode .carousel-dot {
  background: rgba(255,255,255,0.3) !important;
}

html.dark-mode .carousel-dot.active {
  background: rgba(255,255,255,0.8) !important;
}

html.dark-mode .featured-posts-section h2 {
  color: #e0e0e0 !important;
}

.table-panel h2 {
  display: none;
}

.table-panel table {
  border-top-left-radius: 0;
  border-top-right-radius: 0;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}




.toggle-container .toggle-slider {
  position: absolute;
  top: 0;
  left: 0;
  width: 50%;
  height: 100%;
  background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
  border-radius: 8px 0 0 0;
  transition: transform 0.3s ease;
  z-index: 1;
  box-shadow: 0 2px 8px rgba(0,123,255,0.3);
}

.toggle-container input#casual:checked ~ .toggle-slider {
  transform: translateX(100%);
  border-radius: 0 8px 0 0;
}

.toggle-container input#competitive:checked ~ .toggle-slider {
  border-radius: 8px 0 0 0;
}

.toggle-container input#competitive:checked + label {
  color: white;
}
.toggle-container input#casual:checked + label {
  color: white;
}

.toggle-container label:not([for]):hover {
  background-color: rgba(0,0,0,0.05);
}

#competitive:not(:checked) ~ label[for="competitive"]:hover {
  background-color: rgba(0,0,0,0.05);
}

#casual:not(:checked) ~ label[for="casual"]:hover {
  background-color: rgba(0,0,0,0.05);
}

    </style>
<div class="players-page">
  <header>
    <h1>Players</h1>
  </header>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        {% if category == 'error' %}
          <div class="flash-error">{{ message }}</div>
        {% elif category == 'success' %}
          <div class="flash-success">{{ message }}</div>
        {% endif %}
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- FEATURED BLOG POSTS -->
  {% if featured_posts %}
  <div class="featured-posts-section" style="margin-bottom: 2rem;">
    <div class="blog-carousel" style="position: relative; overflow: hidden; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
      <div class="blog-carousel-track" style="display: flex; transition: transform 0.5s ease;">
        {% for post in featured_posts %}
        <div class="blog-slide" style="min-width: 100%; flex-shrink: 0;">
          <div style="position: relative; min-height: 280px; overflow: hidden;">
            {% if post.image_url %}
            <div style="
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background-image: url('{{ url_for('static', filename=post.image_url) }}');
              background-size: cover;
              background-position: center;
              filter: brightness(0.6);">
            </div>
            {% else %}
            <div style="
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              filter: brightness(0.8);">
            </div>
            {% endif %}
            <div class="blog-slide-content" style="
              position: relative;
              z-index: 1;
              padding: 2rem 2.5rem;
              display: flex;
              flex-direction: column;
              justify-content: center;
              min-height: 280px;">
              <h3 style="
                margin: 0 0 0.75rem 0;
                font-size: 1.75rem;
                font-weight: bold;
                color: white;
                line-height: 1.2;
                text-shadow: 2px 2px 8px rgba(0,0,0,0.5);
                max-width: 700px;">
                {{ post.title }}
              </h3>
              <p style="
                margin: 0 0 1.25rem 0;
                font-size: 1rem;
                color: white;
                line-height: 1.5;
                text-shadow: 1px 1px 4px rgba(0,0,0,0.5);
                max-width: 600px;">
                {{ post.content[:200] }}{% if post.content|length > 200 %}...{% endif %}
              </p>
              <div style="
                margin-bottom: 1.25rem;
                font-size: 0.9rem;
                color: rgba(255,255,255,0.9);
                text-shadow: 1px 1px 3px rgba(0,0,0,0.5);">
                <span style="margin-right: 1.5rem;"><strong>By {{ post.author.name }}</strong></span>
                <span>{{ post.created_at.strftime('%b %d, %Y') }}</span>
              </div>
              <div>
                <a href="{{ url_for('blog') }}" class="blog-read-more" style="
                  display: inline-block;
                  padding: 0.65rem 1.5rem;
                  background: rgba(255,255,255,0.95);
                  color: #667eea;
                  text-decoration: none;
                  border-radius: 6px;
                  font-weight: 600;
                  font-size: 0.95rem;
                  transition: transform 0.2s, box-shadow 0.2s;
                  box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                  Read More
                </a>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      
      <!-- Navigation Arrows -->
      <button class="carousel-prev" onclick="moveBlogCarousel(-1)" style="
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(255,255,255,0.9);
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;">
        <i class="material-icons" style="color: #333;">chevron_left</i>
      </button>
      <button class="carousel-next" onclick="moveBlogCarousel(1)" style="
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(255,255,255,0.9);
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;">
        <i class="material-icons" style="color: #333;">chevron_right</i>
      </button>
      
      <!-- Dots Indicator -->
      <div class="carousel-dots" style="
        position: absolute;
        bottom: 1rem;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 0.5rem;">
        {% for i in range(featured_posts|length) %}
        <button class="carousel-dot{% if loop.first %} active{% endif %}" onclick="setBlogCarousel({{ i }})" style="
          width: 10px;
          height: 10px;
          border-radius: 50%;
          border: none;
          background: rgba(255,255,255,0.5);
          cursor: pointer;
          transition: background 0.3s, transform 0.3s;">
        </button>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}

  <!-- FLEX CONTAINER: left tables + right aside -->
  <div style="display:flex; gap:2rem; align-items:flex-start; flex-wrap:nowrap;">
    <!-- LEFT COLUMN -->
    <div style="flex:1; min-width:0; position:relative;" id="tablesColumn">

      <div class="toggle-container" style="margin-bottom:0;">
        <input type="radio" id="competitive" name="toggle" checked>
        <label for="competitive">Competitive</label>
        <input type="radio" id="casual" name="toggle">
        <label for="casual">Casual</label>
        <div class="toggle-slider"></div>
      </div>

      <div class="filters-toolbar">
        <input type="text" id="searchBar" placeholder="ðŸ” Search players...">
        <form method="GET" class="filter-group" id="countryFilterForm">
          <label for="country">Country:</label>
          <select name="country" id="country" class="country-select">
            <option value="">All Countries</option>
            {% if 'AR' in available_countries %}<option value="AR" {% if request.args.get('country') == 'AR' %}selected{% endif %}>ðŸ‡¦ðŸ‡· Argentina</option>{% endif %}
            {% if 'BR' in available_countries %}<option value="BR" {% if request.args.get('country') == 'BR' %}selected{% endif %}>ðŸ‡§ðŸ‡· Brazil</option>{% endif %}
            {% if 'CL' in available_countries %}<option value="CL" {% if request.args.get('country') == 'CL' %}selected{% endif %}>ðŸ‡¨ðŸ‡± Chile</option>{% endif %}
            {% if 'US' in available_countries %}<option value="US" {% if request.args.get('country') == 'US' %}selected{% endif %}>ðŸ‡ºðŸ‡¸ United States</option>{% endif %}
            {% if 'ES' in available_countries %}<option value="ES" {% if request.args.get('country') == 'ES' %}selected{% endif %}>ðŸ‡ªðŸ‡¸ Spain</option>{% endif %}
          </select>
        </form>
      </div>

      <!-- PANELS WRAPPER -->
      <div class="panels-wrapper" style="position:relative;">
        <!-- Competitive table -->
        <div id="competitive-table" class="table-panel active">
          <h2>Competitive Elo</h2>
          <table id="playersTable">
            <tr>
              <th>Rank</th>
              <th>Name</th>
              <th>Elo</th>
              <th>Country</th>
            </tr>
            {% for p in players %}
            <tr class="clickable-row" data-href="{{ url_for('player_info', pid=p.player.id) }}" data-country="{{ player_country(p.player.id) or '' }}">
              <td>
                {% if p.rank %}
                  #{{ p.rank }}
                {% else %}
                  â€“
                {% endif %}
              </td>
              <td>{{ p.player.name }}</td>
              <td>
                {% set num_tournaments = tournaments_played(p.player.id) %}
                {% if num_tournaments < 3 and not current_user.is_admin %}
                  <span style="color:gray;">Hidden</span>
                {% elif num_tournaments < 3 and current_user.is_admin %}
                  {{ p.player.elo }} <span style="color:orange;">(provisional)</span>
                {% else %}
                  {{ p.player.elo }}
                {% endif %}
              </td>
              <td>
                {% if player_country(p.player.id) %}
                  <span class="fi fi-{{ player_country(p.player.id)|lower }}"></span>
                {% else %} â€“ {% endif %}
              </td>
            </tr>
            {% endfor %}
          </table>
        </div>

        <!-- Casual table -->
        <div id="casual-table" class="table-panel">
          <h2>Casual Ranking</h2>
          <table id="casualPlayersTable">
            <tr>
              <th>Rank</th>
              <th>Name</th>
              <th>Casual Points</th>
              <th>Country</th>
            </tr>
            {% for p in casual_players %}
            <tr data-country="{{ player_country(p.player.id) or '' }}">
              <td>#{{ p.rank }}</td>
              <td>{{ p.player.name }}</td>
              <td>{{ p.player.casual_points }}</td>
              <td>
                {% if player_country(p.player.id) %}
                  <span class="fi fi-{{ player_country(p.player.id)|lower }}"></span>
                {% else %} â€“ {% endif %}
              </td>
            </tr>
            {% endfor %}
          </table>
        </div>
      </div>
    </div>

    <!-- RIGHT COLUMN -->
    <aside style="width:240px; flex-shrink:0; margin-top:2.5rem;">
      <a href="{{ url_for('decks_list') }}" class="btn btn-primary" 
         style="display:block; margin-bottom:1rem; text-align:center; padding:1rem; font-size:1.1rem;">
        <i class="material-icons" style="vertical-align:middle; font-size:22px;">style</i> 
        See All Decks
      </a>

      <h3 style="margin-bottom:1rem;">Top Decks</h3>
      {% for deck in top_decks %}
      <a href="{{ url_for('deck_detail', deck_name=deck.name) }}" class="deck-card-link"
         style="display:block; position:relative; margin-bottom:1rem; border-radius:6px; overflow:hidden; text-decoration:none; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <div style="
          background-image: url('{{ url_for('static', filename=deck.image_url) if deck.image_url else '' }}');
          background-size: cover;
          background-position: center;
          height: 120px;
          display: flex;
          align-items: center;
          justify-content: center;">
          <span style="
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            text-shadow: 2px 2px 4px black;
            text-align: center;
            padding: 0.5rem;
            background: rgba(0,0,0,0.3);
            width: 100%;">
            {{ deck.name }}
          </span>
        </div>
      </a>
      {% endfor %}

      <h3 style="margin-bottom:1rem; margin-top:2rem;">Top Stores</h3>
      {% for item in top_stores %}
      <a href="{{ url_for('store_page', store_id=item.store.id) }}" class="store-card-link"
         style="display:block; position:relative; margin-bottom:1rem; border-radius:6px; overflow:hidden; text-decoration:none; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s;">
        <div class="store-card-image" style="
          background-image: url('{{ url_for('static', filename=item.store.image_url) if item.store.image_url else '' }}');
          background-size: cover;
          background-position: center;
          height: 120px;
          background-color: #f0f0f0;">
        </div>
        <div class="store-card-info" style="
          padding: 0.75rem;
          background: white;
          border-top: 1px solid #e0e0e0;">
          <div class="store-card-name" style="
            font-weight: bold;
            font-size: 1rem;
            color: #333;
            margin-bottom: 0.25rem;">
            {{ item.store.name }}
          </div>
          <div class="store-card-location" style="
            font-size: 0.85rem;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: space-between;">
            {% if item.store.location %}
              <span>{{ item.store.location }}</span>
            {% else %}
              <span style="color: #999;">Location not specified</span>
            {% endif %}
            {% if item.store.country %}
              <span class="fi fi-{{ item.store.country|lower }}" style="font-size: 1.2rem;"></span>
            {% endif %}
          </div>
        </div>
      </a>
      {% endfor %}
    </aside>
  </div>
</div>





    {% if current_user.is_authenticated %}
    <div id="mergeModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeMergeModal()">&times;</span>
        <h3 id="mergeTitle">Merge Player</h3>
        <form method="POST" action="{{ url_for('merge_player') }}">
          <input type="hidden" name="source_id" id="mergeSourceId">
          <label>Merge <span id="mergeSourceName"></span> into:</label>
          <select name="target_id" required>
            <option value="">-- Select Player --</option>
{% for p in players %}
  <option value="{{ p.player.id }}">{{ p.player.name }}</option>
{% endfor %}
{% for p in casual_players %}
  <option value="{{ p.player.id }}">{{ p.player.name }}</option>
{% endfor %}

          </select>
          <button type="submit" class="btn btn-primary">Merge</button>
        </form>
      </div>
    </div>
    {% endif %}

<script>
  const mergeModal = document.getElementById("mergeModal");
  const mergeSourceId = document.getElementById("mergeSourceId");
  const mergeSourceName = document.getElementById("mergeSourceName");

  function openMergeModal(id, name) {
    mergeSourceId.value = id;
    mergeSourceName.textContent = name;
    mergeModal.style.display = "block";
  }
  function closeMergeModal() {
    mergeModal.style.display = "none";
  }

  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.btn-merge');
    if (!btn) return;
    const id = btn.getAttribute('data-source-id');
    const name = btn.getAttribute('data-source-name');
    openMergeModal(id, name);
  });

const searchBar = document.getElementById("searchBar");
const countrySelect = document.getElementById("country");

// Prevent form submission and handle client-side
if (countrySelect) {
  countrySelect.form.addEventListener('submit', (e) => {
    e.preventDefault();
  });
  
  countrySelect.addEventListener('change', () => {
    applyFilters();
  });
}

searchBar.addEventListener("keyup", () => {
  applyFilters();
});

function applyFilters() {
  const searchFilter = searchBar.value.toLowerCase();
  const countryFilter = countrySelect ? countrySelect.value : '';

  const rowsToHide = [];
  const rowsToShow = [];

  // Competitive rows
  const compRows = document.querySelectorAll("#playersTable tr:not(:first-child)");
  compRows.forEach(row => {
    const nameCell = row.cells[1].textContent.toLowerCase();
    const rowCountry = row.getAttribute('data-country') || '';
    
    const matchesSearch = nameCell.includes(searchFilter);
    const matchesCountry = !countryFilter || rowCountry === countryFilter;
    
    const shouldBeHidden = !(matchesSearch && matchesCountry);
    const isCurrentlyHidden = row.classList.contains('hidden');
    
    if (shouldBeHidden && !isCurrentlyHidden) {
      rowsToHide.push(row);
    } else if (!shouldBeHidden && isCurrentlyHidden) {
      rowsToShow.push(row);
    }
  });

  // Casual rows
  const casualRows = document.querySelectorAll("#casualPlayersTable tr:not(:first-child)");
  casualRows.forEach(row => {
    const nameCell = row.cells[1].textContent.toLowerCase();
    const rowCountry = row.getAttribute('data-country') || '';
    
    const matchesSearch = nameCell.includes(searchFilter);
    const matchesCountry = !countryFilter || rowCountry === countryFilter;
    
    const shouldBeHidden = !(matchesSearch && matchesCountry);
    const isCurrentlyHidden = row.classList.contains('hidden');
    
    if (shouldBeHidden && !isCurrentlyHidden) {
      rowsToHide.push(row);
    } else if (!shouldBeHidden && isCurrentlyHidden) {
      rowsToShow.push(row);
    }
  });

  // Hide rows with animation
  if (rowsToHide.length > 0) {
    // Remove loaded class to trigger hide animation
    rowsToHide.forEach(row => {
      row.classList.remove('loaded');
    });
    
    // Force reflow
    rowsToHide[0].offsetHeight;
    
    // Add hidden class after CSS transition
    requestAnimationFrame(() => {
      rowsToHide.forEach(row => {
        row.classList.add('hidden');
      });
    });
  }

  // Show rows with animation
  if (rowsToShow.length > 0) {
    rowsToShow.forEach(row => {
      row.classList.remove('hidden');
      row.classList.remove('loaded'); // Remove to reset animation
    });
    
    // Force reflow
    rowsToShow[0].offsetHeight;
    
    // Add loaded class on next frame to trigger animation
    requestAnimationFrame(() => {
      rowsToShow.forEach(row => row.classList.add('loaded'));
    });
  }
}

// Initial page load animation
window.addEventListener('load', () => {
  const allRows = document.querySelectorAll('#playersTable tr:not(:first-child), #casualPlayersTable tr:not(:first-child)');
  
  // Force reflow
  if (allRows.length > 0) {
    allRows[0].offsetHeight;
  }
  
  // Trigger animation
  requestAnimationFrame(() => {
    allRows.forEach(row => {
      if (!row.classList.contains('hidden')) {
        row.classList.add('loaded');
      }
    });
  });
});



  document.querySelectorAll('tr.clickable-row').forEach(row => {
    row.addEventListener('click', () => {
      const href = row.getAttribute('data-href');
      if (href) window.location.href = href;
    });
    row.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        const href = row.getAttribute('data-href');
        if (href) window.location.href = href;
      }
    });
  });

const compPanel = document.getElementById('competitive-table');
const casualPanel = document.getElementById('casual-table');

function swapPanels(showPanel, hidePanel) {
  // Toggle active class for slide transitions
  hidePanel.classList.remove('active');
  showPanel.classList.add('active');
}

document.getElementById('competitive').addEventListener('change', () => {
  swapPanels(compPanel, casualPanel);
});

document.getElementById('casual').addEventListener('change', () => {
  swapPanels(casualPanel, compPanel);
});

// Blog Carousel Functionality
let currentBlogSlide = 0;
const blogTrack = document.querySelector('.blog-carousel-track');
const blogSlides = document.querySelectorAll('.blog-slide');
const blogDots = document.querySelectorAll('.carousel-dot');
const totalBlogSlides = blogSlides.length;

function updateBlogCarousel() {
  if (blogTrack) {
    blogTrack.style.transform = `translateX(-${currentBlogSlide * 100}%)`;
    
    // Update dots
    blogDots.forEach((dot, index) => {
      if (index === currentBlogSlide) {
        dot.classList.add('active');
      } else {
        dot.classList.remove('active');
      }
    });
  }
}

function moveBlogCarousel(direction) {
  currentBlogSlide += direction;
  
  // Loop around
  if (currentBlogSlide < 0) {
    currentBlogSlide = totalBlogSlides - 1;
  } else if (currentBlogSlide >= totalBlogSlides) {
    currentBlogSlide = 0;
  }
  
  updateBlogCarousel();
}

function setBlogCarousel(index) {
  currentBlogSlide = index;
  updateBlogCarousel();
}

// Auto-play carousel (optional)
let blogCarouselInterval = setInterval(() => {
  if (totalBlogSlides > 1) {
    moveBlogCarousel(1);
  }
}, 5000); // Change slide every 5 seconds

// Pause auto-play on hover
const blogCarousel = document.querySelector('.blog-carousel');
if (blogCarousel) {
  blogCarousel.addEventListener('mouseenter', () => {
    clearInterval(blogCarouselInterval);
  });
  
  blogCarousel.addEventListener('mouseleave', () => {
    blogCarouselInterval = setInterval(() => {
      if (totalBlogSlides > 1) {
        moveBlogCarousel(1);
      }
    }, 5000);
  });
}

</script>



{% endblock %}
